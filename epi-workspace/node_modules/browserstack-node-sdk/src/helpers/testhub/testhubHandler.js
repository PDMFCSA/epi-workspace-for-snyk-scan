const a126_0x5d184d=a126_0x16f9;(function(_0x5b96c7,_0x29d76e){const _0x8c8e48=a126_0x16f9,_0x298104=_0x5b96c7();while(!![]){try{const _0x293f41=-parseInt(_0x8c8e48(0x198))/0x1+-parseInt(_0x8c8e48(0x13b))/0x2+parseInt(_0x8c8e48(0x13a))/0x3+parseInt(_0x8c8e48(0x166))/0x4+parseInt(_0x8c8e48(0x16b))/0x5*(parseInt(_0x8c8e48(0x174))/0x6)+parseInt(_0x8c8e48(0x17a))/0x7+-parseInt(_0x8c8e48(0x13e))/0x8*(-parseInt(_0x8c8e48(0x196))/0x9);if(_0x293f41===_0x29d76e)break;else _0x298104['push'](_0x298104['shift']());}catch(_0x512916){_0x298104['push'](_0x298104['shift']());}}}(a126_0x3371,0x37133));const bsSetupHelper=require('../helper'),path=require(a126_0x5d184d(0x122)),util=require(a126_0x5d184d(0x145)),{getCustomTags,isTestObservabilitySession,getDefaultHeaders,nodeRequest}=require('../test-observability/utils'),testhubUtils=require('./utils.js'),testHubConstants=require(a126_0x5d184d(0x139)),constants=require(a126_0x5d184d(0x16a)),RequestQueueHandler=require(a126_0x5d184d(0x185)),logger=require('../logger')['winstonLogger'],SessionHandler=require(a126_0x5d184d(0x121)),PerformanceTester=require(a126_0x5d184d(0x12f)),{TESTHUB_EVENTS:PerformanceEvents}=require('../performance/constants'),TestDetails=require(a126_0x5d184d(0x114)),{uploadTraceZip}=require(a126_0x5d184d(0x11a)),{isTurboScaleSession}=require(a126_0x5d184d(0x189)),BrowserstackCLI=require(a126_0x5d184d(0x17b)),OngoingEvents=new Set();function a126_0x3371(){const _0x2f4b2e=['ENV_VAR','lcnc','getProductMap','EXCEPTION\x20IN\x20BUILD\x20START\x20EVENT\x20:\x20Missing\x20authentication\x20token','xCokW','TESTHUB_BUILD_API','assign','stop','checkAndSetupPercy','resolve','djWGt','BROWSERSTACK_LINKED_BUILD_UUID','AZLHZ','jwt','format','isRunning','1126224YFerLt','BROWSERSTACK_TESTHUB_UUID','message','TlneF','../../bin/utils/constants.js','20900WatVBp','getAccessibilityOptions','settings','uploadPending','getConfig','response','getProductMapForBuildStartCall','forEach','true','18fQGYiM','cwd','processTraceZips','fvaKx','bmjxA','auth','2955764tCaaIT','../../bin/v2/browserstackCLI','statusText','isBrowserstackInfra','push','stringify','allSettled','EXCEPTION\x20IN\x20stopBuildUpstream\x20REQUEST\x20TO\x20TESTHUB\x20:\x20','logBuildError','Token/buildID\x20is\x20undefined,\x20build\x20creation\x20might\x20have\x20failed','env','../test-observability/requestQueueHandler.js','accessibilityOptions','central_scanner','includeEncodedExtension','../helper.js','TkXiW','ajtLb','EXCEPTION\x20IN\x20stopBuildUpstream\x20REQUEST\x20TO\x20TESTHUB\x20:\x20Missing\x20authentication\x20token','BROWSERSTACK_RERUN','password','setTestHubCommonMetaInfo','BROWSERSTACK_TESTHUB_JWT','oRcyy','ahRLu','getCentralUser','getAccessKey','getFrameworkDetails','9675sCrlgU','prsPz','414178cvYlcF','accessibility','POTjg','\x20framework','buildStopSent','GEitM','status','bSnTL','BROWSERSTACK_TEST_ACCESSIBILITY_PLATFORM','buildDescription','CGhVY','XlUTA','username','hVAtK','kdFBF','Error\x20while\x20waiting\x20for\x20events:\x20','cozXk','PUT','../../bin/playwright/reporter/test-details.js','HYpHQ','BROWSERSTACK_PRODUCT_MAP','includes','config','BROWSERSTACK_BUILD_GROUPING_IDENTIFIER','../../bin/playwright/reporter/pwUtils.js','getUserName','DOEbN','BS_TESTOPS_BUILD_COMPLETED','START','FfVPn','XroxS','../test-observability/sessionHandler.js','path','jpJvq','info','setAccessibilityVariables','extractDataFromResponse','BROWSERSTACK_ACCESSIBILITY','success','NyJbs','BROWSERSTACK_CENTRAL_SCANNER_JOBID','BROWSERSTACK_TEST_OBSERVABILITY','pNtKr','buildIdentifier','basename','../performance/performance-tester.js','OBSERVABILITY','getCiInfo','user_killed','WAtnC','getInstance','getAccessibilityValueFromYml','finished_metadata','setTestObservabilityVariables','allowScreenshot','./constants.js','695856krMnsB','748220yhIlIL','ppaOr','HCuLD','488kZQZVK','waitForBuildStatus','BROWSERSTACK_CENTRAL_SCANNER_JWT','error','buildHashedId','debug','token','util','getTestOrchestrationBuildStartData','authToken','projectName','generateBuildUpstreamData','fLDgj','launchBuild','add','ACCESSIBILITY','measureWrapper','data','false','All\x20trace\x20zip\x20send\x20events\x20complete','toISOString','isAccessibilityEnabled','VoDpN','framework'];a126_0x3371=function(){return _0x2f4b2e;};return a126_0x3371();}let processedTraceZips=![];function a126_0x16f9(_0x576568,_0x2d0999){const _0x3371bd=a126_0x3371();return a126_0x16f9=function(_0x16f909,_0xb8df6d){_0x16f909=_0x16f909-0x10c;let _0x194742=_0x3371bd[_0x16f909];return _0x194742;},a126_0x16f9(_0x576568,_0x2d0999);}const addEvent=_0x4adc2d=>{const _0x3138d7=a126_0x5d184d;OngoingEvents[_0x3138d7(0x14c)](_0x4adc2d);},awaitAllEvents=async()=>{const _0x45ca43=a126_0x5d184d;return Promise[_0x45ca43(0x180)](OngoingEvents);};class TestHubHandler{static [a126_0x5d184d(0x19c)]=![];static async[a126_0x5d184d(0x14b)](_0x3ea122,_0xb08e32){const _0x2f0416=a126_0x5d184d,_0x100c39={'WAtnC':function(_0x264ea4,_0x2fd246){return _0x264ea4||_0x2fd246;},'AZLHZ':function(_0x83dcd,_0x5f5362){return _0x83dcd||_0x5f5362;},'ahRLu':function(_0x2409e8,_0x2b11e6){return _0x2409e8===_0x2b11e6;},'kdFBF':function(_0x1e63c0){return _0x1e63c0();},'WWosY':_0x2f0416(0x159),'ppaOr':_0x2f0416(0x150),'jLzhT':'Exception\x20while\x20creating\x20test\x20run\x20for\x20BrowserStack\x20Accessibility\x20Automation:\x20Missing\x20authentication\x20token','JuDMK':function(_0x406e5e,_0x41d04c,_0x10bd23,_0x1dd94b,_0x999fd8){return _0x406e5e(_0x41d04c,_0x10bd23,_0x1dd94b,_0x999fd8);},'TkXiW':'POST','fvaKx':function(_0x308c2c,_0xf81999){return _0x308c2c===_0xf81999;},'xCokW':_0x2f0416(0x199),'POTjg':_0x2f0416(0x173)};await PerformanceTester[_0x2f0416(0x14e)](PerformanceEvents[_0x2f0416(0x11e)],async()=>{const _0x4eebaf=_0x2f0416,_0x1f67ef=Object[_0x4eebaf(0x15c)]({},_0xb08e32[_0x4eebaf(0x118)],{'root_dir_path':'','framework':_0xb08e32[_0x4eebaf(0x155)]}),_0x57faad=bsSetupHelper[_0x4eebaf(0x11b)](_0x1f67ef),_0xe1b332=bsSetupHelper[_0x4eebaf(0x194)](_0x1f67ef),_0x13a4b3=_0x100c39[_0x4eebaf(0x133)](_0x57faad,'')+':'+_0x100c39[_0x4eebaf(0x162)](_0xe1b332,''),_0x4f156f=testhubUtils[_0x4eebaf(0x158)](_0x1f67ef);process[_0x4eebaf(0x184)][_0x4eebaf(0x116)]=JSON[_0x4eebaf(0x17f)](_0x4f156f);if(_0x100c39[_0x4eebaf(0x192)](_0x13a4b3,':'))return _0x100c39[_0x4eebaf(0x110)](isTestObservabilitySession)&&(logger['debug'](_0x100c39['WWosY']),process[_0x4eebaf(0x184)][_0x4eebaf(0x11d)]=_0x100c39[_0x4eebaf(0x13c)]),testhubUtils[_0x4eebaf(0x153)](_0x1f67ef)&&logger['debug'](_0x100c39['jLzhT']),[null,null];try{const _0x3c0eaf=await this[_0x4eebaf(0x149)](_0x1f67ef,_0x3ea122),_0x5643c5=this['getConfig'](_0x57faad,_0xe1b332),_0x455d52=await _0x100c39['JuDMK'](nodeRequest,_0x100c39[_0x4eebaf(0x18a)],testHubConstants[_0x4eebaf(0x15b)],_0x3c0eaf,_0x5643c5),_0x54612b=this[_0x4eebaf(0x126)](_0x1f67ef,_0x455d52,_0x5643c5);await this[_0x4eebaf(0x15e)](_0xb08e32,_0x3ea122);if(_0x100c39[_0x4eebaf(0x177)](testhubUtils[_0x4eebaf(0x135)](_0xb08e32['config']),null)){const _0x4e9009=_0x54612b[_0x100c39[_0x4eebaf(0x15a)]];_0x4e9009&&_0x4e9009['authToken']&&_0x4e9009[_0x4eebaf(0x142)]&&(_0xb08e32[_0x4eebaf(0x118)]['accessibility']=!![],process[_0x4eebaf(0x184)][_0x4eebaf(0x1a0)]=_0x100c39[_0x4eebaf(0x19a)]);}return _0x54612b;}catch(_0x2a723f){if(_0x100c39[_0x4eebaf(0x177)](_0x2a723f[_0x4eebaf(0x128)],![])){testhubUtils[_0x4eebaf(0x182)](_0x2a723f);return;}}})();}static async['processTraceZips'](){const _0x3ff6d3=a126_0x5d184d,_0x3eb5dd={'jpJvq':function(_0x5e1f86,_0x161373,_0x4530aa){return _0x5e1f86(_0x161373,_0x4530aa);},'hVAtK':function(_0x558212,_0x12f12a){return _0x558212(_0x12f12a);},'FfVPn':function(_0x34c843){return _0x34c843();},'oRcyy':_0x3ff6d3(0x151)};if(processedTraceZips)return;const _0x69b605=TestDetails['getTraceFilePaths']();_0x69b605[_0x3ff6d3(0x172)](({testUId:_0x45e8ee,filePath:_0x254e59})=>{const _0x143b75=_0x3ff6d3;var _0x417133=_0x3eb5dd[_0x143b75(0x123)](uploadTraceZip,_0x254e59,_0x45e8ee);_0x3eb5dd[_0x143b75(0x10f)](addEvent,_0x417133);});try{await _0x3eb5dd[_0x3ff6d3(0x11f)](awaitAllEvents),logger[_0x3ff6d3(0x143)](_0x3eb5dd[_0x3ff6d3(0x191)]),processedTraceZips=!![];}catch(_0x57d420){logger['error'](_0x3ff6d3(0x111)+util[_0x3ff6d3(0x164)](_0x57d420));}}static async[a126_0x5d184d(0x15e)](_0x15d223,_0x376252){const _0x15cd2b=a126_0x5d184d;if(constants['PERCY_SUPPORTED_FRAMEWORKS'][_0x15cd2b(0x117)](_0x376252)){await _0x15d223['setupPercy']();return;}_0x15d223[_0x15cd2b(0x118)]['percy']&&logger['debug']('Percy\x20is\x20not\x20supported\x20for\x20'+_0x376252+_0x15cd2b(0x19b));}static[a126_0x5d184d(0x16c)](_0x262ee9){const _0x4b15d4=a126_0x5d184d,_0x500ccc={'bmjxA':function(_0x4b5750,_0x2a3101){return _0x4b5750(_0x2a3101);},'NyJbs':'true'};let _0x11b40b;if(_0x262ee9[_0x4b15d4(0x186)]){const _0x39eef2={};_0x39eef2['settings']=_0x262ee9['accessibilityOptions'],_0x11b40b=_0x39eef2;}else{const _0x3640fc={};_0x3640fc['settings']={},_0x11b40b=_0x3640fc;}if((!bsSetupHelper['isBrowserstackInfra']()||_0x500ccc[_0x4b15d4(0x178)](isTurboScaleSession,_0x262ee9))&&testhubUtils['isAccessibilityEnabled'](_0x262ee9)){const _0x54db52={};_0x54db52[_0x4b15d4(0x188)]=_0x500ccc[_0x4b15d4(0x129)],Object[_0x4b15d4(0x15c)](_0x11b40b[_0x4b15d4(0x16d)],_0x54db52);}return _0x11b40b;}static[a126_0x5d184d(0x16f)](_0x5af43c,_0x2819f9){const _0x59146=a126_0x5d184d,_0x4de69f={'XroxS':function(_0x1005c1,_0x2ae669){return _0x1005c1(_0x2ae669);}},_0xc5818={};return _0xc5818[_0x59146(0x10e)]=_0x5af43c,_0xc5818[_0x59146(0x18e)]=_0x2819f9,{'auth':_0xc5818,'headers':_0x4de69f[_0x59146(0x120)](getDefaultHeaders,![])};}static async[a126_0x5d184d(0x149)](_0x2de34b,_0x2b6e89){const _0x2ae333=a126_0x5d184d,_0x13a0c8={'CGhVY':'Generating\x20build\x20upstream\x20data\x20for\x20TestHub','bSnTL':function(_0x3a2564,_0x149f33){return _0x3a2564(_0x149f33);}};logger[_0x2ae333(0x143)](_0x13a0c8[_0x2ae333(0x10c)]);const _0x194d3b={'project_name':_0x2de34b[_0x2ae333(0x148)]||'','name':_0x2de34b['buildName']||path[_0x2ae333(0x12e)](path[_0x2ae333(0x15f)](process[_0x2ae333(0x175)]())),'build_identifier':_0x2de34b[_0x2ae333(0x12d)],'description':_0x2de34b[_0x2ae333(0x1a1)]||'','started_at':new Date()['toISOString'](),'tags':_0x13a0c8[_0x2ae333(0x19f)](getCustomTags,_0x2de34b),'host_info':bsSetupHelper['getHostInfo'](),'ci_info':bsSetupHelper[_0x2ae333(0x131)](),'build_run_identifier':process[_0x2ae333(0x184)]['BROWSERSTACK_BUILD_RUN_IDENTIFIER'],'failed_tests_rerun':process[_0x2ae333(0x184)][_0x2ae333(0x18d)]||![],'linked_build_uuid':process[_0x2ae333(0x184)][_0x2ae333(0x161)]||'','version_control':await bsSetupHelper['getGitMetaData'](),'accessibility':this['getAccessibilityOptions'](_0x2de34b),'framework_details':testhubUtils[_0x2ae333(0x195)](_0x2de34b,_0x2b6e89),'product_map':testhubUtils[_0x2ae333(0x171)](_0x2de34b),'browserstackAutomation':bsSetupHelper[_0x2ae333(0x17d)](),'grouping_identifier':process['env'][_0x2ae333(0x119)],'test_orchestration':testhubUtils[_0x2ae333(0x146)](_0x2de34b)};if(bsSetupHelper[_0x2ae333(0x193)]()[_0x2ae333(0x187)]||bsSetupHelper[_0x2ae333(0x193)]()[_0x2ae333(0x157)]){const _0x409f98={};_0x409f98['job_id']=process[_0x2ae333(0x184)][_0x2ae333(0x12a)],_0x409f98[_0x2ae333(0x144)]=process[_0x2ae333(0x184)][_0x2ae333(0x140)],_0x194d3b[_0x2ae333(0x187)]=_0x409f98;}return _0x194d3b;}static['extractDataFromResponse'](_0x15576e,_0x5a58ec,_0x42a0ed){const _0x1de717=a126_0x5d184d,_0x2eaf34={'Afaju':function(_0x49af0e){return _0x49af0e();},'prsPz':function(_0x2ea546,_0x434136){return _0x2ea546&&_0x434136;},'GEitM':_0x1de717(0x173),'TlneF':_0x1de717(0x150)},_0x387b89={};if(_0x2eaf34['Afaju'](isTestObservabilitySession)){const [_0x2760f1,_0x559bf6,_0x481614]=testhubUtils[_0x1de717(0x137)](_0x5a58ec[_0x1de717(0x14f)],_0x42a0ed[_0x1de717(0x179)]);if(_0x2eaf34[_0x1de717(0x197)](_0x2760f1,_0x559bf6)){const _0x3159c3={};_0x3159c3[_0x1de717(0x163)]=_0x2760f1,_0x3159c3[_0x1de717(0x142)]=_0x559bf6,_0x3159c3[_0x1de717(0x138)]=_0x481614,_0x387b89[testHubConstants['OBSERVABILITY']]=_0x3159c3,process[_0x1de717(0x184)][_0x1de717(0x12b)]=_0x2eaf34[_0x1de717(0x19d)];}else _0x387b89[testHubConstants[_0x1de717(0x130)]]={},process[_0x1de717(0x184)][_0x1de717(0x12b)]=_0x2eaf34['TlneF'];}else process[_0x1de717(0x184)][_0x1de717(0x12b)]=_0x2eaf34[_0x1de717(0x169)];const [_0x5580ee,_0x21ab2e]=testhubUtils[_0x1de717(0x125)](_0x5a58ec[_0x1de717(0x14f)]);if(_0x2eaf34[_0x1de717(0x197)](_0x5580ee,_0x21ab2e)){const _0x1a0e3f={};_0x1a0e3f[_0x1de717(0x147)]=_0x5580ee,_0x1a0e3f['buildHashedId']=_0x21ab2e,_0x387b89[testHubConstants[_0x1de717(0x14d)]]=_0x1a0e3f,process[_0x1de717(0x184)]['BROWSERSTACK_ACCESSIBILITY']=_0x2eaf34[_0x1de717(0x19d)];}else _0x387b89[testHubConstants[_0x1de717(0x14d)]]={},process['env'][_0x1de717(0x127)]=_0x2eaf34[_0x1de717(0x169)];return testhubUtils[_0x1de717(0x18f)](_0x5a58ec['data']),logger[_0x1de717(0x124)]('Testhub\x20started\x20with\x20id:\x20'+process[_0x1de717(0x184)]['BROWSERSTACK_TESTHUB_UUID']),_0x387b89;}static async[a126_0x5d184d(0x15d)](_0x2d6f82){const _0x383108=a126_0x5d184d,_0x53d54c={'cozXk':function(_0x18b155,_0x3068f1){return _0x18b155===_0x3068f1;},'HCuLD':_0x383108(0x150),'VoDpN':'null','jJveY':_0x383108(0x18c),'fLDgj':_0x383108(0x141),'ajtLb':_0x383108(0x183),'HYpHQ':_0x383108(0x136),'DOEbN':_0x383108(0x132),'XlUTA':function(_0x96efec){return _0x96efec();},'GZznr':function(_0x4fc4d4,_0x4447a1,_0x3a9279,_0x46e943,_0x3a9a69,_0x54ea70){return _0x4fc4d4(_0x4447a1,_0x3a9279,_0x46e943,_0x3a9a69,_0x54ea70);},'djWGt':_0x383108(0x113),'pNtKr':'stopBuildUpstream\x20event\x20successful!','UhCOI':_0x383108(0x128)};!BrowserstackCLI[_0x383108(0x134)]()[_0x383108(0x165)]()&&await this[_0x383108(0x176)](),await PerformanceTester['measureWrapper'](PerformanceEvents['STOP'],async()=>{const _0x5d3c78=_0x383108;if(_0x53d54c['cozXk'](process[_0x5d3c78(0x184)][_0x5d3c78(0x11d)],_0x53d54c[_0x5d3c78(0x13d)])||TestHubHandler[_0x5d3c78(0x19c)]||bsSetupHelper['isUndefined'](process[_0x5d3c78(0x184)][testHubConstants[_0x5d3c78(0x156)][_0x5d3c78(0x190)]]))return;TestHubHandler[_0x5d3c78(0x19c)]=!![],await RequestQueueHandler[_0x5d3c78(0x134)]()[_0x5d3c78(0x16e)](),await SessionHandler[_0x5d3c78(0x13f)]();if(_0x53d54c[_0x5d3c78(0x112)](process[_0x5d3c78(0x184)][testHubConstants[_0x5d3c78(0x156)]['BROWSERSTACK_TESTHUB_JWT']],_0x53d54c[_0x5d3c78(0x154)])||_0x53d54c[_0x5d3c78(0x112)](process['env'][testHubConstants[_0x5d3c78(0x156)][_0x5d3c78(0x167)]],_0x53d54c[_0x5d3c78(0x154)])){logger[_0x5d3c78(0x143)](_0x53d54c['jJveY']);const _0x4db0bb={};return _0x4db0bb['status']=_0x53d54c[_0x5d3c78(0x14a)],_0x4db0bb[_0x5d3c78(0x168)]=_0x53d54c[_0x5d3c78(0x18b)],_0x4db0bb;}const _0x40be80={'finished_at':new Date()[_0x5d3c78(0x152)](),'finished_metadata':[]};!!_0x2d6f82&&_0x40be80[_0x53d54c[_0x5d3c78(0x115)]][_0x5d3c78(0x17e)]({'reason':_0x53d54c[_0x5d3c78(0x11c)],'signal':_0x2d6f82,'failure_data':''});const _0xf1d2f9={'headers':_0x53d54c[_0x5d3c78(0x10d)](getDefaultHeaders)};try{const _0x503473=await _0x53d54c['GZznr'](nodeRequest,_0x53d54c[_0x5d3c78(0x160)],'api/v1/builds/'+process[_0x5d3c78(0x184)][testHubConstants['ENV_VAR'][_0x5d3c78(0x167)]]+'/stop',_0x40be80,_0xf1d2f9,![]);if(_0x503473[_0x5d3c78(0x14f)]&&_0x503473[_0x5d3c78(0x14f)][_0x5d3c78(0x141)]){const _0x2e9044={};_0x2e9044[_0x5d3c78(0x168)]=_0x503473[_0x5d3c78(0x14f)][_0x5d3c78(0x141)];throw _0x2e9044;}else{logger[_0x5d3c78(0x143)](_0x53d54c[_0x5d3c78(0x12c)]);const _0x1c5d39={};return _0x1c5d39['status']=_0x53d54c['UhCOI'],_0x1c5d39[_0x5d3c78(0x168)]='',_0x1c5d39;}}catch(_0x441b72){_0x441b72[_0x5d3c78(0x170)]?logger[_0x5d3c78(0x143)](_0x5d3c78(0x181)+_0x441b72[_0x5d3c78(0x170)][_0x5d3c78(0x19e)]+'\x20'+_0x441b72['response'][_0x5d3c78(0x17c)]+'\x20'+JSON[_0x5d3c78(0x17f)](_0x441b72[_0x5d3c78(0x170)]['data'])):logger[_0x5d3c78(0x143)]('EXCEPTION\x20IN\x20stopBuildUpstream\x20REQUEST\x20TO\x20TESTHUB\x20:\x20'+(_0x441b72[_0x5d3c78(0x168)]||_0x441b72));const _0x1deb4b={};return _0x1deb4b['status']=_0x53d54c['fLDgj'],_0x1deb4b[_0x5d3c78(0x168)]=_0x441b72['message']||_0x441b72[_0x5d3c78(0x170)]?_0x441b72['response']['status']+':'+_0x441b72[_0x5d3c78(0x170)][_0x5d3c78(0x17c)]:_0x441b72,_0x1deb4b;}})();}}module['exports']=TestHubHandler;