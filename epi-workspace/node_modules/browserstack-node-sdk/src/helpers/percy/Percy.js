const a113_0x27f212=a113_0x36cd;(function(_0x2670c3,_0x1cd49c){const _0x412633=a113_0x36cd,_0x2b658f=_0x2670c3();while(!![]){try{const _0xe01e3e=parseInt(_0x412633(0xe3))/0x1+-parseInt(_0x412633(0xdd))/0x2*(-parseInt(_0x412633(0xff))/0x3)+-parseInt(_0x412633(0x11d))/0x4+-parseInt(_0x412633(0xfc))/0x5+parseInt(_0x412633(0x116))/0x6*(-parseInt(_0x412633(0xf1))/0x7)+parseInt(_0x412633(0x11a))/0x8*(-parseInt(_0x412633(0x10c))/0x9)+parseInt(_0x412633(0xfd))/0xa;if(_0xe01e3e===_0x1cd49c)break;else _0x2b658f['push'](_0x2b658f['shift']());}catch(_0x4aacc7){_0x2b658f['push'](_0x2b658f['shift']());}}}(a113_0x2283,0xe3e67));function a113_0x36cd(_0x508227,_0x3affd0){const _0x2283ba=a113_0x2283();return a113_0x36cd=function(_0x36cd3a,_0x36f2ef){_0x36cd3a=_0x36cd3a-0xd6;let _0x47e663=_0x2283ba[_0x36cd3a];return _0x47e663;},a113_0x36cd(_0x508227,_0x3affd0);}function a113_0x2283(){const _0x51e06a=['close','612fCebjs','getBinaryPath','vKIzS','Percy\x20fetch\x20token\x20success','Percy\x20healthcheck\x20successful','createPercyConfig','DApKH','projectName','isProcessRunning','wltFv','780qijTju','zBBJl','pipe','zetam','27080TYXLcU','percy.log','../logger','5108820SqMKQa','writeFile','../../helpers/performance/constants','tmpdir','flags','start','createWriteStream','./PercyBinary','exports','percyOptions','isRunning','6XbVYkX','BROWSERSTACK_TESTHUB_UUID','app','nodeRequest','join','FDDpW','180460SnJptJ','exec:stop','dVAiT','qvgIV','debug','PERCY_SERVER_ADDRESS','env','stringify','assign','data','../helper','baZPI','LhbcT','healthcheck','1778YXMRvZ','token','stop','fetchPercyToken','ZLOUW','../../helpers/testhub/constants','app:exec','Error\x20creating\x20percy\x20config:\x20','&type=','child_process','end','4883470XRzmWz','24951040IyAZgO','stderr','775014Lwyitf','push','GET','version','Percy\x20unable\x20to\x20fetch\x20project\x20token:\x20','kcvHZ','dGnCY','error',':start','automate','ENV_VAR','DOWNLOAD'];a113_0x2283=function(){return _0x51e06a;};return a113_0x2283();}const fs=require('fs'),path=require('path'),os=require('os'),{spawn}=require(a113_0x27f212(0xfa)),helper=require(a113_0x27f212(0xed)),logger=require(a113_0x27f212(0x11c))['winstonLogger'],{getLogDir}=require(a113_0x27f212(0x11c)),testHubConstants=require(a113_0x27f212(0xf6)),PerformanceTester=require('../../helpers/performance/performance-tester'),{PERCY_EVENTS:PerformanceEvents}=require(a113_0x27f212(0x11f)),PercyBinary=require(a113_0x27f212(0xd9));class Percy{#logfile=path[a113_0x27f212(0xe1)](getLogDir(),a113_0x27f212(0x11b));#address=process[a113_0x27f212(0xe9)][a113_0x27f212(0xe8)]||'http://localhost:5338';#binaryPath=null;#config=null;#proc=null;#logStream=null;#isApp=![];[a113_0x27f212(0x114)]=![];constructor(_0x4ef4c0){const _0x3c5e8e=a113_0x27f212;this.#config=_0x4ef4c0,!!_0x4ef4c0[_0x3c5e8e(0xdf)]&&(this.#isApp=!![]);}async #getBinaryPath(){const _0xb93988=a113_0x27f212;if(!this.#binaryPath){const _0x2d5d13=new PercyBinary();PerformanceTester[_0xb93988(0xd7)](PerformanceEvents['DOWNLOAD']),this.#binaryPath=await _0x2d5d13[_0xb93988(0x10d)](this.#config),PerformanceTester[_0xb93988(0xfb)](PerformanceEvents[_0xb93988(0x10a)]);}return this.#binaryPath;}async #sleep(_0x26984e){return new Promise(_0x447c18=>setTimeout(_0x447c18,_0x26984e));}async[a113_0x27f212(0xf0)](){const _0x30d9a6=a113_0x27f212,_0x459fe8={};_0x459fe8['ZLOUW']=_0x30d9a6(0x101),_0x459fe8['LhbcT']='percy/healthcheck';const _0x564530=_0x459fe8;try{const _0x128e4a=await helper[_0x30d9a6(0xe0)](_0x564530[_0x30d9a6(0xf5)],_0x564530[_0x30d9a6(0xef)],null,null,this.#address);if(_0x128e4a)return!![];}catch(_0x29fa13){return![];}}async[a113_0x27f212(0xd7)](){const _0x4aba8c=a113_0x27f212,_0x5e2b01={'baZPI':_0x4aba8c(0xf7),'qvgIV':'exec','kHXNQ':function(_0x5c9ac8,_0x313d72,_0x186f9e,_0x51528a){return _0x5c9ac8(_0x313d72,_0x186f9e,_0x51528a);},'chIeM':_0x4aba8c(0x10b),'wltFv':_0x4aba8c(0x110)},_0x4c1d7b=await this.#getBinaryPath(),_0x75edc2={};_0x75edc2[_0x4aba8c(0xd6)]='a',this.#logStream=fs[_0x4aba8c(0xd8)](this.#logfile,_0x75edc2);const _0x149b3d=await this[_0x4aba8c(0xf4)](),_0x245472=await this[_0x4aba8c(0x111)]();if(!_0x149b3d)return![];const _0x117435=[(this.#isApp?_0x5e2b01[_0x4aba8c(0xee)]:_0x5e2b01[_0x4aba8c(0xe6)])+_0x4aba8c(0x107)];_0x245472&&_0x117435[_0x4aba8c(0x100)]('-c',_0x245472);this.#proc=_0x5e2b01['kHXNQ'](spawn,_0x4c1d7b,_0x117435,{'env':Object[_0x4aba8c(0xeb)](process[_0x4aba8c(0xe9)],{'PERCY_TOKEN':_0x149b3d,'TH_BUILD_UUID':process[_0x4aba8c(0xe9)][testHubConstants[_0x4aba8c(0x109)][_0x4aba8c(0xde)]]})}),this.#proc['stdout'][_0x4aba8c(0x118)](this.#logStream),this.#proc[_0x4aba8c(0xfe)][_0x4aba8c(0x118)](this.#logStream),this['isProcessRunning']=!![];var _0x3c8d29=this;this.#proc['on'](_0x5e2b01['chIeM'],function(_0x5ca599){const _0x30c41c=_0x4aba8c;_0x3c8d29[_0x30c41c(0x114)]=![];});do{const _0x1ad399=await this[_0x4aba8c(0xf0)]();if(_0x1ad399)return logger[_0x4aba8c(0xe7)](_0x5e2b01[_0x4aba8c(0x115)]),!![];await this.#sleep(0x3e8);}while(this[_0x4aba8c(0x114)]);return![];}async[a113_0x27f212(0xf3)](){const _0x333a60=a113_0x27f212,_0x202cdf={'ECHly':function(_0x81e524,_0x298725){return _0x81e524(_0x298725);},'kDqxt':function(_0x1985f3,_0x25216d,_0x470fe9){return _0x1985f3(_0x25216d,_0x470fe9);},'LoyfC':_0x333a60(0xe4),'dGnCY':_0x333a60(0x10b)},_0x41cbe5=await this.#getBinaryPath();return new Promise((_0x1fbf56,_0x39ac33)=>{const _0x1943bc=_0x333a60,_0x31e3a4=_0x202cdf['kDqxt'](spawn,_0x41cbe5,[_0x202cdf['LoyfC']]);_0x31e3a4['on'](_0x202cdf[_0x1943bc(0x105)],_0xa8df3a=>{const _0x39cd11=_0x1943bc;this[_0x39cd11(0x114)]=![],this.#logStream&&(this.#logStream[_0x39cd11(0xfb)](),this.#logStream=null),_0x202cdf['ECHly'](_0x1fbf56,_0xa8df3a);});});}[a113_0x27f212(0xdc)](){const _0x574e08=a113_0x27f212;return this[_0x574e08(0x114)];}async['fetchPercyToken'](){const _0x53dfc9=a113_0x27f212,_0x131e6e={};_0x131e6e['DApKH']='app',_0x131e6e[_0x53dfc9(0x10e)]=_0x53dfc9(0x108),_0x131e6e['zetam']=_0x53dfc9(0x101),_0x131e6e['ITaXf']=_0x53dfc9(0x10f);const _0x318aa7=_0x131e6e,_0x47304d=this.#config[_0x53dfc9(0x113)];try{const _0x4726fb=this.#isApp?_0x318aa7[_0x53dfc9(0x112)]:_0x318aa7[_0x53dfc9(0x10e)],_0xcc73f6=await helper[_0x53dfc9(0xe0)](_0x318aa7[_0x53dfc9(0x119)],'api/app_percy/get_project_token?name='+_0x47304d+_0x53dfc9(0xf9)+_0x4726fb,{},this.#config),_0x5ccef8=_0xcc73f6[_0x53dfc9(0xec)];return logger['debug'](_0x318aa7['ITaXf']),_0x5ccef8[_0x53dfc9(0xf2)];}catch(_0x281f2e){return logger[_0x53dfc9(0x106)](_0x53dfc9(0x103)+_0x281f2e),null;}}async['createPercyConfig'](){const _0x152557=a113_0x27f212,_0x51dc9c={'dVAiT':function(_0x43e250,_0x1e9d2a){return _0x43e250(_0x1e9d2a);},'zBBJl':function(_0x54c1ed,_0xcb1542){return _0x54c1ed+_0xcb1542;},'kcvHZ':'Percy\x20config\x20created\x20at\x20','FDDpW':'percy.json'};if(!this.#config[_0x152557(0xdb)])return null;const _0x3cf698=path['join'](os[_0x152557(0x120)](),_0x51dc9c[_0x152557(0xe2)]),_0x119659=this.#config['percyOptions'];return!_0x119659[_0x152557(0x102)]&&(_0x119659[_0x152557(0x102)]='2'),new Promise((_0xe8f39d,_0x508e32)=>{const _0x5b9f39=_0x152557;fs[_0x5b9f39(0x11e)](_0x3cf698,JSON[_0x5b9f39(0xea)](_0x119659),_0x2b50ff=>{const _0x5e20a9=_0x5b9f39;_0x2b50ff&&(logger[_0x5e20a9(0x106)](_0x5e20a9(0xf8)+_0x2b50ff),_0x51dc9c[_0x5e20a9(0xe5)](_0xe8f39d,null)),logger[_0x5e20a9(0xe7)](_0x51dc9c[_0x5e20a9(0x117)](_0x51dc9c[_0x5e20a9(0x104)],_0x3cf698)),_0x51dc9c[_0x5e20a9(0xe5)](_0xe8f39d,_0x3cf698);});});}}module[a113_0x27f212(0xda)]=Percy;