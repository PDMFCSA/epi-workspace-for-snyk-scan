const a103_0x4c218d=a103_0xe9a7;function a103_0xe9a7(_0x428df5,_0x4c9233){const _0x52ab6d=a103_0x52ab();return a103_0xe9a7=function(_0xe9a722,_0x59ef66){_0xe9a722=_0xe9a722-0x1cc;let _0x5df7a4=_0x52ab6d[_0xe9a722];return _0x5df7a4;},a103_0xe9a7(_0x428df5,_0x4c9233);}function a103_0x52ab(){const _0x46503c=['GET','push','createWriteStream','debug','1767633LvfMAR','app','ENV_VAR','end','pipe','nodeRequest','HyDQP','start','env','healthcheck','token','writeFile','12huJiPb','close','YFOAl','OzkUp','2075596ZWlIdG','600XuSrxY','join','5847846aRTeUg','&type=','../../helpers/performance/constants','data','./PercyBinary','stop','Percy\x20fetch\x20token\x20success','10270381TsllSo','74410MZrSiQ','exports','projectName','Percy\x20healthcheck\x20successful','version','8JmVSES','stringify','percyOptions','TkPZh','stderr','flags','LeLoL','stdout','34280HqrSms','getBinaryPath','zbbLv','../../helpers/testhub/constants','PhfUv','http://localhost:5338','isProcessRunning','../logger','277366DKUKlt','createPercyConfig','xYNWS','exec','ahzbS','5wPClEA','QRitg','YFUnQ','RXzei','ggdhR',':start','tcDlk','YMQHw','MdlLa','DOWNLOAD','winstonLogger','PERCY_SERVER_ADDRESS','Error\x20creating\x20percy\x20config:\x20','1557EZSZwn'];a103_0x52ab=function(){return _0x46503c;};return a103_0x52ab();}(function(_0x1ca1af,_0x83bde8){const _0x4082e9=a103_0xe9a7,_0xccca9d=_0x1ca1af();while(!![]){try{const _0x188a1a=-parseInt(_0x4082e9(0x1d6))/0x1*(-parseInt(_0x4082e9(0x20d))/0x2)+-parseInt(_0x4082e9(0x1ed))/0x3+-parseInt(_0x4082e9(0x1fd))/0x4*(-parseInt(_0x4082e9(0x1db))/0x5)+-parseInt(_0x4082e9(0x200))/0x6+parseInt(_0x4082e9(0x208))/0x7*(-parseInt(_0x4082e9(0x1fe))/0x8)+-parseInt(_0x4082e9(0x1e8))/0x9*(-parseInt(_0x4082e9(0x1ce))/0xa)+-parseInt(_0x4082e9(0x207))/0xb*(-parseInt(_0x4082e9(0x1f9))/0xc);if(_0x188a1a===_0x83bde8)break;else _0xccca9d['push'](_0xccca9d['shift']());}catch(_0x50b561){_0xccca9d['push'](_0xccca9d['shift']());}}}(a103_0x52ab,0xc1d78));const fs=require('fs'),path=require('path'),os=require('os'),{spawn}=require('child_process'),helper=require('../helper'),logger=require('../logger')[a103_0x4c218d(0x1e5)],{getLogDir}=require(a103_0x4c218d(0x1d5)),testHubConstants=require(a103_0x4c218d(0x1d1)),PerformanceTester=require('../../helpers/performance/performance-tester'),{PERCY_EVENTS:PerformanceEvents}=require(a103_0x4c218d(0x202)),PercyBinary=require(a103_0x4c218d(0x204));class Percy{#logfile=path['join'](getLogDir(),'percy.log');#address=process['env'][a103_0x4c218d(0x1e6)]||a103_0x4c218d(0x1d3);#binaryPath=null;#config=null;#proc=null;#isApp=![];[a103_0x4c218d(0x1d4)]=![];constructor(_0x430cb9){const _0x4aef98=a103_0x4c218d;this.#config=_0x430cb9,!!_0x430cb9[_0x4aef98(0x1ee)]&&(this.#isApp=!![]);}async #getBinaryPath(){const _0x4d7083=a103_0x4c218d;if(!this.#binaryPath){const _0x5ef2a1=new PercyBinary();PerformanceTester[_0x4d7083(0x1f4)](PerformanceEvents['DOWNLOAD']),this.#binaryPath=await _0x5ef2a1[_0x4d7083(0x1cf)](this.#config),PerformanceTester[_0x4d7083(0x1f0)](PerformanceEvents[_0x4d7083(0x1e4)]);}return this.#binaryPath;}async #sleep(_0x210c20){return new Promise(_0x59d8a8=>setTimeout(_0x59d8a8,_0x210c20));}async[a103_0x4c218d(0x1f6)](){const _0x5a6f6a=a103_0x4c218d,_0x1b3529={};_0x1b3529[_0x5a6f6a(0x1da)]=_0x5a6f6a(0x1e9),_0x1b3529[_0x5a6f6a(0x210)]='percy/healthcheck';const _0x2fb6d0=_0x1b3529;try{const _0x1006a5=await helper[_0x5a6f6a(0x1f2)](_0x2fb6d0[_0x5a6f6a(0x1da)],_0x2fb6d0[_0x5a6f6a(0x210)],null,null,this.#address);if(_0x1006a5)return!![];}catch(_0x59127f){return![];}}async['start'](){const _0x30b96a=a103_0x4c218d,_0x288fc2={'zbbLv':'app:exec','MdlLa':_0x30b96a(0x1d9),'PhfUv':function(_0x3eaddd,_0x2fa307,_0x3005a9,_0x5692f4){return _0x3eaddd(_0x2fa307,_0x3005a9,_0x5692f4);},'XHzfI':'close','Hwwww':_0x30b96a(0x20b)},_0x475498=await this.#getBinaryPath(),_0x445eb1={};_0x445eb1[_0x30b96a(0x212)]='a';const _0x598b4e=fs[_0x30b96a(0x1eb)](this.#logfile,_0x445eb1),_0x1060b4=await this['fetchPercyToken'](),_0x2e1956=await this[_0x30b96a(0x1d7)]();if(!_0x1060b4)return![];const _0x44658c=[(this.#isApp?_0x288fc2[_0x30b96a(0x1d0)]:_0x288fc2[_0x30b96a(0x1e3)])+_0x30b96a(0x1e0)];_0x2e1956&&_0x44658c[_0x30b96a(0x1ea)]('-c',_0x2e1956);this.#proc=_0x288fc2[_0x30b96a(0x1d2)](spawn,_0x475498,_0x44658c,{'env':Object['assign'](process[_0x30b96a(0x1f5)],{'PERCY_TOKEN':_0x1060b4,'TH_BUILD_UUID':process[_0x30b96a(0x1f5)][testHubConstants[_0x30b96a(0x1ef)]['BROWSERSTACK_TESTHUB_UUID']]})}),this.#proc[_0x30b96a(0x1cd)][_0x30b96a(0x1f1)](_0x598b4e),this.#proc[_0x30b96a(0x211)][_0x30b96a(0x1f1)](_0x598b4e),this['isProcessRunning']=!![];var _0x224df8=this;this.#proc['on'](_0x288fc2['XHzfI'],function(_0x3ceec4){const _0x20d668=_0x30b96a;_0x224df8[_0x20d668(0x1d4)]=![];});do{const _0x507a23=await this['healthcheck']();if(_0x507a23)return logger['debug'](_0x288fc2['Hwwww']),!![];await this.#sleep(0x3e8);}while(this['isProcessRunning']);return![];}async[a103_0x4c218d(0x205)](){const _0x2e9ec7=a103_0x4c218d,_0x1a3751={'OzkUp':function(_0x4f64cb,_0x18e56e){return _0x4f64cb(_0x18e56e);},'SKUGZ':function(_0x4198e8,_0x5a1bf4,_0x37fe1a){return _0x4198e8(_0x5a1bf4,_0x37fe1a);},'QRitg':'exec:stop','LeLoL':_0x2e9ec7(0x1fa)},_0x6fbd91=await this.#getBinaryPath();return new Promise((_0x199101,_0x25aa9d)=>{const _0x38814a=_0x2e9ec7,_0x22a773={'HyDQP':function(_0x1f8872,_0x46bd72){const _0x1489db=a103_0xe9a7;return _0x1a3751[_0x1489db(0x1fc)](_0x1f8872,_0x46bd72);}},_0x1fe056=_0x1a3751['SKUGZ'](spawn,_0x6fbd91,[_0x1a3751[_0x38814a(0x1dc)]]);_0x1fe056['on'](_0x1a3751[_0x38814a(0x1cc)],_0x13af51=>{const _0x15ef2a=_0x38814a;this[_0x15ef2a(0x1d4)]=![],_0x22a773[_0x15ef2a(0x1f3)](_0x199101,_0x13af51);});});}['isRunning'](){const _0x41d334=a103_0x4c218d;return this[_0x41d334(0x1d4)];}async['fetchPercyToken'](){const _0x503f57=a103_0x4c218d,_0x2d3a2c={};_0x2d3a2c['FDnvV']=_0x503f57(0x1ee),_0x2d3a2c[_0x503f57(0x1dd)]='automate',_0x2d3a2c[_0x503f57(0x1df)]=_0x503f57(0x1e9),_0x2d3a2c[_0x503f57(0x1de)]=_0x503f57(0x206);const _0xf7c522=_0x2d3a2c,_0x5a1866=this.#config[_0x503f57(0x20a)];try{const _0x5df963=this.#isApp?_0xf7c522['FDnvV']:_0xf7c522[_0x503f57(0x1dd)],_0x41bcf8=await helper[_0x503f57(0x1f2)](_0xf7c522[_0x503f57(0x1df)],'api/app_percy/get_project_token?name='+_0x5a1866+_0x503f57(0x201)+_0x5df963,{},this.#config),_0x232730=_0x41bcf8[_0x503f57(0x203)];return logger[_0x503f57(0x1ec)](_0xf7c522['RXzei']),_0x232730[_0x503f57(0x1f7)];}catch(_0x36fd94){return logger['error']('Percy\x20unable\x20to\x20fetch\x20project\x20token:\x20'+_0x36fd94),null;}}async['createPercyConfig'](){const _0x3a7b72=a103_0x4c218d,_0x29c78d={'YFOAl':function(_0x557f77,_0x5979fe){return _0x557f77(_0x5979fe);},'xYNWS':function(_0x4b570b,_0x3dff68){return _0x4b570b+_0x3dff68;},'YMQHw':'Percy\x20config\x20created\x20at\x20','tcDlk':'percy.json'};if(!this.#config[_0x3a7b72(0x20f)])return null;const _0x12dbe7=path[_0x3a7b72(0x1ff)](os['tmpdir'](),_0x29c78d[_0x3a7b72(0x1e1)]),_0x2bf1a0=this.#config[_0x3a7b72(0x20f)];return!_0x2bf1a0[_0x3a7b72(0x20c)]&&(_0x2bf1a0[_0x3a7b72(0x20c)]='2'),new Promise((_0x38f8c3,_0x34bd23)=>{const _0x533fed=_0x3a7b72;fs[_0x533fed(0x1f8)](_0x12dbe7,JSON[_0x533fed(0x20e)](_0x2bf1a0),_0x5ec20f=>{const _0x4eb483=_0x533fed;_0x5ec20f&&(logger['error'](_0x4eb483(0x1e7)+_0x5ec20f),_0x29c78d[_0x4eb483(0x1fb)](_0x38f8c3,null)),logger['debug'](_0x29c78d[_0x4eb483(0x1d8)](_0x29c78d[_0x4eb483(0x1e2)],_0x12dbe7)),_0x29c78d[_0x4eb483(0x1fb)](_0x38f8c3,_0x12dbe7);});});}}module[a103_0x4c218d(0x209)]=Percy;