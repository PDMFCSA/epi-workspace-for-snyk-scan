const a72_0x598f30=a72_0x1cad;(function(_0x1e15e3,_0x2cee11){const _0x1d66ab=a72_0x1cad,_0x47eb79=_0x1e15e3();while(!![]){try{const _0x526fc6=parseInt(_0x1d66ab(0x18c))/0x1+parseInt(_0x1d66ab(0x187))/0x2+parseInt(_0x1d66ab(0x1a7))/0x3+parseInt(_0x1d66ab(0x1b8))/0x4*(parseInt(_0x1d66ab(0x17a))/0x5)+-parseInt(_0x1d66ab(0x188))/0x6+parseInt(_0x1d66ab(0x1a6))/0x7+-parseInt(_0x1d66ab(0x193))/0x8;if(_0x526fc6===_0x2cee11)break;else _0x47eb79['push'](_0x47eb79['shift']());}catch(_0x173c37){_0x47eb79['push'](_0x47eb79['shift']());}}}(a72_0x51d3,0x279db));function a72_0x51d3(){const _0x3ebe07=['join','start','fetchPercyToken','nnodt','pipe',':start','535imzbKI','stringify','http://localhost:5338','data','ZWcoX','Percy\x20unable\x20to\x20fetch\x20project\x20token:\x20','exec:stop','getBinaryPath','../../helpers/performance/performance-tester','close','Percy\x20fetch\x20token\x20success','app:exec','nkRew','397212uaMbNn','23076OKtmZV','../../helpers/performance/constants','assign','child_process','208857EmIseh','qKWvH','../../helpers/testhub/constants','exec','Percy\x20healthcheck\x20successful','nBBoF','createWriteStream','5546552tMcYXL','fRUxT','Percy\x20config\x20created\x20at\x20','rKROa','exports','percy/healthcheck','stop','DOWNLOAD','percyOptions','NXimE','IAicV','jzfqV','push','end','GET','nodeRequest','percy.log','BROWSERSTACK_TESTHUB_UUID','app','882665BTpahU','716970VonUtY','PXfUT','writeFile','stdout','createPercyConfig','env','WZnWY','debug','usnmK','isProcessRunning','lsSAn','version','path','ENV_VAR','Joogw','projectName','healthcheck','3248QcntHx'];a72_0x51d3=function(){return _0x3ebe07;};return a72_0x51d3();}const fs=require('fs'),path=require(a72_0x598f30(0x1b3)),os=require('os'),{spawn}=require(a72_0x598f30(0x18b)),helper=require('../helper'),logger=require('../logger')['winstonLogger'],{logDir}=require('../logger'),testHubConstants=require(a72_0x598f30(0x18e)),PerformanceTester=require(a72_0x598f30(0x182)),{PERCY_EVENTS:PerformanceEvents}=require(a72_0x598f30(0x189)),PercyBinary=require('./PercyBinary');function a72_0x1cad(_0xedb290,_0x46194d){const _0x51d37d=a72_0x51d3();return a72_0x1cad=function(_0x1cada0,_0xe9dc16){_0x1cada0=_0x1cada0-0x176;let _0x5aab85=_0x51d37d[_0x1cada0];return _0x5aab85;},a72_0x1cad(_0xedb290,_0x46194d);}class Percy{#logfile=path[a72_0x598f30(0x1b9)](logDir,a72_0x598f30(0x1a3));#address=process[a72_0x598f30(0x1ac)]['PERCY_SERVER_ADDRESS']||a72_0x598f30(0x17c);#binaryPath=null;#config=null;#proc=null;#isApp=![];['isProcessRunning']=![];constructor(_0xd6d3aa){const _0x5aa68a=a72_0x598f30;this.#config=_0xd6d3aa,!!_0xd6d3aa[_0x5aa68a(0x1a5)]&&(this.#isApp=!![]);}async #getBinaryPath(){const _0x1c8bd4=a72_0x598f30;if(!this.#binaryPath){const _0x189c3c=new PercyBinary();PerformanceTester['start'](PerformanceEvents[_0x1c8bd4(0x19a)]),this.#binaryPath=await _0x189c3c[_0x1c8bd4(0x181)](this.#config),PerformanceTester[_0x1c8bd4(0x1a0)](PerformanceEvents['DOWNLOAD']);}return this.#binaryPath;}async #sleep(_0x5ef386){return new Promise(_0x57a612=>setTimeout(_0x57a612,_0x5ef386));}async['healthcheck'](){const _0x1cf998=a72_0x598f30,_0x1a8ded={};_0x1a8ded[_0x1cf998(0x17e)]=_0x1cf998(0x1a1),_0x1a8ded[_0x1cf998(0x186)]=_0x1cf998(0x198);const _0x4d33a6=_0x1a8ded;try{const _0x44c2e3=await helper['nodeRequest'](_0x4d33a6['ZWcoX'],_0x4d33a6[_0x1cf998(0x186)],null,null,this.#address);if(_0x44c2e3)return!![];}catch(_0x5f21ee){return![];}}async[a72_0x598f30(0x1ba)](){const _0x43f76d=a72_0x598f30,_0x230014={'WKjNm':_0x43f76d(0x185),'nBBoF':_0x43f76d(0x18f),'rKROa':function(_0x39eb57,_0x26f083,_0x1db7ce,_0x2359e0){return _0x39eb57(_0x26f083,_0x1db7ce,_0x2359e0);},'nnodt':_0x43f76d(0x183),'aQpKN':_0x43f76d(0x190)},_0x3bd404=await this.#getBinaryPath(),_0x1915aa={};_0x1915aa['flags']='a';const _0x5190c6=fs[_0x43f76d(0x192)](this.#logfile,_0x1915aa),_0x2e9b5e=await this[_0x43f76d(0x176)](),_0x1337fc=await this[_0x43f76d(0x1ab)]();if(!_0x2e9b5e)return![];const _0x270ceb=[(this.#isApp?_0x230014['WKjNm']:_0x230014[_0x43f76d(0x191)])+_0x43f76d(0x179)];_0x1337fc&&_0x270ceb[_0x43f76d(0x19f)]('-c',_0x1337fc);this.#proc=_0x230014[_0x43f76d(0x196)](spawn,_0x3bd404,_0x270ceb,{'env':Object[_0x43f76d(0x18a)](process[_0x43f76d(0x1ac)],{'PERCY_TOKEN':_0x2e9b5e,'TH_BUILD_UUID':process[_0x43f76d(0x1ac)][testHubConstants[_0x43f76d(0x1b4)][_0x43f76d(0x1a4)]]})}),this.#proc[_0x43f76d(0x1aa)][_0x43f76d(0x178)](_0x5190c6),this.#proc['stderr'][_0x43f76d(0x178)](_0x5190c6),this[_0x43f76d(0x1b0)]=!![];var _0x1ee36d=this;this.#proc['on'](_0x230014[_0x43f76d(0x177)],function(_0x4a389e){const _0x563ca6=_0x43f76d;_0x1ee36d[_0x563ca6(0x1b0)]=![];});do{const _0x3a35ca=await this[_0x43f76d(0x1b7)]();if(_0x3a35ca)return logger['debug'](_0x230014['aQpKN']),!![];await this.#sleep(0x3e8);}while(this['isProcessRunning']);return![];}async[a72_0x598f30(0x199)](){const _0x570e49=a72_0x598f30,_0x132654={'QCKqQ':function(_0x4c27bb,_0x3024f0){return _0x4c27bb(_0x3024f0);},'BjOcV':function(_0x19658f,_0x1bba7a,_0x27ec05){return _0x19658f(_0x1bba7a,_0x27ec05);},'lsSAn':_0x570e49(0x180),'usnmK':_0x570e49(0x183)},_0x5aca94=await this.#getBinaryPath();return new Promise((_0x551c08,_0x5e0138)=>{const _0x4d9629=_0x570e49,_0x13fbbf={'sTShJ':function(_0x5ba4ea,_0x47d559){return _0x132654['QCKqQ'](_0x5ba4ea,_0x47d559);}},_0x5bdc8e=_0x132654['BjOcV'](spawn,_0x5aca94,[_0x132654[_0x4d9629(0x1b1)]]);_0x5bdc8e['on'](_0x132654[_0x4d9629(0x1af)],_0x802d08=>{const _0x24da6e=_0x4d9629;this[_0x24da6e(0x1b0)]=![],_0x13fbbf['sTShJ'](_0x551c08,_0x802d08);});});}['isRunning'](){const _0x4f74cf=a72_0x598f30;return this[_0x4f74cf(0x1b0)];}async[a72_0x598f30(0x176)](){const _0x5b3ca0=a72_0x598f30,_0x3d3292={};_0x3d3292[_0x5b3ca0(0x1b5)]=_0x5b3ca0(0x1a5),_0x3d3292['NXimE']='automate',_0x3d3292[_0x5b3ca0(0x19e)]=_0x5b3ca0(0x1a1),_0x3d3292['qKWvH']=_0x5b3ca0(0x184);const _0x23185a=_0x3d3292,_0x35e058=this.#config[_0x5b3ca0(0x1b6)];try{const _0x11ab4f=this.#isApp?_0x23185a[_0x5b3ca0(0x1b5)]:_0x23185a[_0x5b3ca0(0x19c)],_0x3112fa=await helper[_0x5b3ca0(0x1a2)](_0x23185a['jzfqV'],'api/app_percy/get_project_token?name='+_0x35e058+'&type='+_0x11ab4f,{},this.#config),_0x2e9e91=_0x3112fa[_0x5b3ca0(0x17d)];return logger[_0x5b3ca0(0x1ae)](_0x23185a[_0x5b3ca0(0x18d)]),_0x2e9e91['token'];}catch(_0x142c5c){return logger['error'](_0x5b3ca0(0x17f)+_0x142c5c),null;}}async[a72_0x598f30(0x1ab)](){const _0x1b1877=a72_0x598f30,_0x2fdb04={'IAicV':function(_0x727e3b,_0x2b348f){return _0x727e3b(_0x2b348f);},'PXfUT':function(_0x18cc16,_0x35da65){return _0x18cc16+_0x35da65;},'fRUxT':_0x1b1877(0x195),'WZnWY':'percy.json'};if(!this.#config['percyOptions'])return null;const _0x521163=path[_0x1b1877(0x1b9)](os['tmpdir'](),_0x2fdb04[_0x1b1877(0x1ad)]),_0x392175=this.#config[_0x1b1877(0x19b)];return!_0x392175[_0x1b1877(0x1b2)]&&(_0x392175[_0x1b1877(0x1b2)]='2'),new Promise((_0x395548,_0x100fd0)=>{const _0x377454=_0x1b1877;fs[_0x377454(0x1a9)](_0x521163,JSON[_0x377454(0x17b)](_0x392175),_0x573ff3=>{const _0x6ce9ce=_0x377454;_0x573ff3&&(logger['error']('Error\x20creating\x20percy\x20config:\x20'+_0x573ff3),_0x2fdb04[_0x6ce9ce(0x19d)](_0x395548,null)),logger[_0x6ce9ce(0x1ae)](_0x2fdb04[_0x6ce9ce(0x1a8)](_0x2fdb04[_0x6ce9ce(0x194)],_0x521163)),_0x2fdb04['IAicV'](_0x395548,_0x521163);});});}}module[a72_0x598f30(0x197)]=Percy;