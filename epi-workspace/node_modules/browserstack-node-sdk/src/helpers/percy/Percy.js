const a101_0x100545=a101_0xa996;function a101_0x693f(){const _0x1dec8b=['env','writeFile','bZySM','10539683pPAuax','data','JYeKC','ulOgr','fetchPercyToken','974alxqZz','Percy\x20config\x20created\x20at\x20','GET','uVSTd','IFGNb','stringify','1655809zhmxUE','4960320GKjdeL','Percy\x20healthcheck\x20successful','stdout','kwhQl','Ewpus','rIhUu','percyOptions','start','../../helpers/performance/performance-tester','Percy\x20unable\x20to\x20fetch\x20project\x20token:\x20','flags','vaoKE','push','1760MWhOCl','BWNfu',':start','child_process','debug','OcStt','Error\x20creating\x20percy\x20config:\x20','createPercyConfig','2661595MLWqOH','14706QVKRAB','JPBFt','path','app','api/app_percy/get_project_token?name=','../helper','bxuxO','join','3296VxmRGX','token','exec','../../helpers/performance/constants','version','GXOkx','12021JnLmNM','stop','../logger','isProcessRunning','Percy\x20fetch\x20token\x20success','pipe','healthcheck','DOWNLOAD','automate','winstonLogger','percy/healthcheck','ENV_VAR','xYKkx','getBinaryPath','12FxaPAH','close','BROWSERSTACK_TESTHUB_UUID','vFcQd','app:exec','94810fHDZcE','nodeRequest','exec:stop'];a101_0x693f=function(){return _0x1dec8b;};return a101_0x693f();}(function(_0x3c893e,_0x25d8ba){const _0x693f4e=a101_0xa996,_0x2e65d9=_0x3c893e();while(!![]){try{const _0x2c4e9d=parseInt(_0x693f4e(0x1f3))/0x1+-parseInt(_0x693f4e(0x1ed))/0x2*(parseInt(_0x693f4e(0x1cf))/0x3)+-parseInt(_0x693f4e(0x1dd))/0x4*(parseInt(_0x693f4e(0x1c0))/0x5)+-parseInt(_0x693f4e(0x1f4))/0x6+parseInt(_0x693f4e(0x1e8))/0x7+-parseInt(_0x693f4e(0x1c9))/0x8*(-parseInt(_0x693f4e(0x1c1))/0x9)+-parseInt(_0x693f4e(0x1e2))/0xa*(-parseInt(_0x693f4e(0x1b8))/0xb);if(_0x2c4e9d===_0x25d8ba)break;else _0x2e65d9['push'](_0x2e65d9['shift']());}catch(_0x5b1278){_0x2e65d9['push'](_0x2e65d9['shift']());}}}(a101_0x693f,0xee6b0));const fs=require('fs'),path=require(a101_0x100545(0x1c3)),os=require('os'),{spawn}=require(a101_0x100545(0x1bb)),helper=require(a101_0x100545(0x1c6)),logger=require('../logger')[a101_0x100545(0x1d8)],{getLogDir}=require(a101_0x100545(0x1d1)),testHubConstants=require('../../helpers/testhub/constants'),PerformanceTester=require(a101_0x100545(0x1fc)),{PERCY_EVENTS:PerformanceEvents}=require(a101_0x100545(0x1cc)),PercyBinary=require('./PercyBinary');function a101_0xa996(_0x2eb429,_0x13b070){const _0x693f36=a101_0x693f();return a101_0xa996=function(_0xa99623,_0x5dff1c){_0xa99623=_0xa99623-0x1b4;let _0x5e7c21=_0x693f36[_0xa99623];return _0x5e7c21;},a101_0xa996(_0x2eb429,_0x13b070);}class Percy{#logfile=path['join'](getLogDir(),'percy.log');#address=process[a101_0x100545(0x1e5)]['PERCY_SERVER_ADDRESS']||'http://localhost:5338';#binaryPath=null;#config=null;#proc=null;#isApp=![];[a101_0x100545(0x1d2)]=![];constructor(_0x45d014){const _0x1390c7=a101_0x100545;this.#config=_0x45d014,!!_0x45d014[_0x1390c7(0x1c4)]&&(this.#isApp=!![]);}async #getBinaryPath(){const _0x3290c9=a101_0x100545;if(!this.#binaryPath){const _0x21eb6d=new PercyBinary();PerformanceTester[_0x3290c9(0x1fb)](PerformanceEvents[_0x3290c9(0x1d6)]),this.#binaryPath=await _0x21eb6d[_0x3290c9(0x1dc)](this.#config),PerformanceTester['end'](PerformanceEvents[_0x3290c9(0x1d6)]);}return this.#binaryPath;}async #sleep(_0x1041d3){return new Promise(_0x132901=>setTimeout(_0x132901,_0x1041d3));}async[a101_0x100545(0x1d5)](){const _0xfc855c=a101_0x100545,_0x40fd26={};_0x40fd26[_0xfc855c(0x1e7)]=_0xfc855c(0x1ef),_0x40fd26['uVSTd']=_0xfc855c(0x1d9);const _0x46a001=_0x40fd26;try{const _0x1cfa7a=await helper[_0xfc855c(0x1e3)](_0x46a001[_0xfc855c(0x1e7)],_0x46a001[_0xfc855c(0x1f0)],null,null,this.#address);if(_0x1cfa7a)return!![];}catch(_0x39dc82){return![];}}async[a101_0x100545(0x1fb)](){const _0xba15aa=a101_0x100545,_0x1647a0={'GXOkx':_0xba15aa(0x1e1),'rIhUu':_0xba15aa(0x1cb),'kwhQl':function(_0x5a042f,_0x24c849,_0x1b622a,_0x128c73){return _0x5a042f(_0x24c849,_0x1b622a,_0x128c73);},'pvYXn':_0xba15aa(0x1de),'BWNfu':_0xba15aa(0x1f5)},_0x4b2b1d=await this.#getBinaryPath(),_0x25ef6a={};_0x25ef6a[_0xba15aa(0x1b5)]='a';const _0x55a06f=fs['createWriteStream'](this.#logfile,_0x25ef6a),_0x17a9cb=await this['fetchPercyToken'](),_0x3383b1=await this['createPercyConfig']();if(!_0x17a9cb)return![];const _0xd1bbaa=[(this.#isApp?_0x1647a0[_0xba15aa(0x1ce)]:_0x1647a0[_0xba15aa(0x1f9)])+_0xba15aa(0x1ba)];_0x3383b1&&_0xd1bbaa[_0xba15aa(0x1b7)]('-c',_0x3383b1);this.#proc=_0x1647a0[_0xba15aa(0x1f7)](spawn,_0x4b2b1d,_0xd1bbaa,{'env':Object['assign'](process[_0xba15aa(0x1e5)],{'PERCY_TOKEN':_0x17a9cb,'TH_BUILD_UUID':process[_0xba15aa(0x1e5)][testHubConstants[_0xba15aa(0x1da)][_0xba15aa(0x1df)]]})}),this.#proc[_0xba15aa(0x1f6)][_0xba15aa(0x1d4)](_0x55a06f),this.#proc['stderr'][_0xba15aa(0x1d4)](_0x55a06f),this[_0xba15aa(0x1d2)]=!![];var _0x614914=this;this.#proc['on'](_0x1647a0['pvYXn'],function(_0x29a070){const _0x8fc734=_0xba15aa;_0x614914[_0x8fc734(0x1d2)]=![];});do{const _0x3aef7d=await this['healthcheck']();if(_0x3aef7d)return logger[_0xba15aa(0x1bc)](_0x1647a0[_0xba15aa(0x1b9)]),!![];await this.#sleep(0x3e8);}while(this[_0xba15aa(0x1d2)]);return![];}async[a101_0x100545(0x1d0)](){const _0x4a5799=a101_0x100545,_0x397362={'JYeKC':function(_0x4c7062,_0x4e2850){return _0x4c7062(_0x4e2850);},'bxuxO':function(_0x2ec2f0,_0x17b27a,_0x5f08ea){return _0x2ec2f0(_0x17b27a,_0x5f08ea);},'OcStt':_0x4a5799(0x1e4),'ulOgr':_0x4a5799(0x1de)},_0x5a7ef8=await this.#getBinaryPath();return new Promise((_0x3f2147,_0xd4ee17)=>{const _0xfd12af=_0x4a5799,_0xaea1e7=_0x397362[_0xfd12af(0x1c7)](spawn,_0x5a7ef8,[_0x397362[_0xfd12af(0x1bd)]]);_0xaea1e7['on'](_0x397362[_0xfd12af(0x1eb)],_0x5ca072=>{const _0x3f6cfd=_0xfd12af;this[_0x3f6cfd(0x1d2)]=![],_0x397362[_0x3f6cfd(0x1ea)](_0x3f2147,_0x5ca072);});});}['isRunning'](){const _0x1e94e6=a101_0x100545;return this[_0x1e94e6(0x1d2)];}async[a101_0x100545(0x1ec)](){const _0x2b7391=a101_0x100545,_0x2f0730={};_0x2f0730[_0x2b7391(0x1b6)]=_0x2b7391(0x1c4),_0x2f0730[_0x2b7391(0x1db)]=_0x2b7391(0x1d7),_0x2f0730[_0x2b7391(0x1f8)]=_0x2b7391(0x1ef),_0x2f0730[_0x2b7391(0x1c2)]=_0x2b7391(0x1d3);const _0x5e64ec=_0x2f0730,_0x192616=this.#config['projectName'];try{const _0x2eaa8a=this.#isApp?_0x5e64ec[_0x2b7391(0x1b6)]:_0x5e64ec['xYKkx'],_0x50e174=await helper[_0x2b7391(0x1e3)](_0x5e64ec[_0x2b7391(0x1f8)],_0x2b7391(0x1c5)+_0x192616+'&type='+_0x2eaa8a,{},this.#config),_0x5cdb65=_0x50e174[_0x2b7391(0x1e9)];return logger[_0x2b7391(0x1bc)](_0x5e64ec[_0x2b7391(0x1c2)]),_0x5cdb65[_0x2b7391(0x1ca)];}catch(_0x34ac8b){return logger['error'](_0x2b7391(0x1b4)+_0x34ac8b),null;}}async[a101_0x100545(0x1bf)](){const _0x15bac2=a101_0x100545,_0x5b3d90={'MuJfn':function(_0x1df69f,_0x3be00f){return _0x1df69f(_0x3be00f);},'urprb':function(_0x294e7e,_0x4b5615){return _0x294e7e+_0x4b5615;},'hJCpY':_0x15bac2(0x1ee),'IFGNb':function(_0x4800e2,_0x1fd882){return _0x4800e2(_0x1fd882);},'vFcQd':'percy.json'};if(!this.#config[_0x15bac2(0x1fa)])return null;const _0x192dce=path[_0x15bac2(0x1c8)](os['tmpdir'](),_0x5b3d90[_0x15bac2(0x1e0)]),_0x89c645=this.#config['percyOptions'];return!_0x89c645[_0x15bac2(0x1cd)]&&(_0x89c645[_0x15bac2(0x1cd)]='2'),new Promise((_0x5dc104,_0x3b2be2)=>{const _0x55f26a=_0x15bac2;fs[_0x55f26a(0x1e6)](_0x192dce,JSON[_0x55f26a(0x1f2)](_0x89c645),_0x1b525d=>{const _0x498f85=_0x55f26a;_0x1b525d&&(logger['error'](_0x498f85(0x1be)+_0x1b525d),_0x5b3d90['MuJfn'](_0x5dc104,null)),logger[_0x498f85(0x1bc)](_0x5b3d90['urprb'](_0x5b3d90['hJCpY'],_0x192dce)),_0x5b3d90[_0x498f85(0x1f1)](_0x5dc104,_0x192dce);});});}}module['exports']=Percy;