const a113_0x55f401=a113_0x5c99;function a113_0x5c99(_0x3c97bd,_0x2ed070){const _0x4e4120=a113_0x4e41();return a113_0x5c99=function(_0x5c99cc,_0x4d022c){_0x5c99cc=_0x5c99cc-0x13c;let _0x38c5b5=_0x4e4120[_0x5c99cc];return _0x38c5b5;},a113_0x5c99(_0x3c97bd,_0x2ed070);}(function(_0x537d09,_0x20d3d3){const _0x384711=a113_0x5c99,_0x3d8ed2=_0x537d09();while(!![]){try{const _0xce5bf8=parseInt(_0x384711(0x159))/0x1+parseInt(_0x384711(0x168))/0x2+-parseInt(_0x384711(0x14d))/0x3*(parseInt(_0x384711(0x142))/0x4)+-parseInt(_0x384711(0x14b))/0x5+parseInt(_0x384711(0x16c))/0x6+-parseInt(_0x384711(0x14f))/0x7+-parseInt(_0x384711(0x182))/0x8*(-parseInt(_0x384711(0x183))/0x9);if(_0xce5bf8===_0x20d3d3)break;else _0x3d8ed2['push'](_0x3d8ed2['shift']());}catch(_0x495e37){_0x3d8ed2['push'](_0x3d8ed2['shift']());}}}(a113_0x4e41,0x8f8ab));function a113_0x4e41(){const _0x45a11d=['data','GCVaK','stringify','version','lsacB','path','stderr','createPercyConfig','stop','../../helpers/performance/constants','app','424tSfDwW','218574fDRKEW','ENV_VAR','join','../helper','CqekF','assign','UfRAm','writeFile','LiXWS','child_process','percy/healthcheck','Ourbz','PERCY_SERVER_ADDRESS','GET','InemD','20sCRCQR','push','isRunning','qBmqj','createWriteStream','uubIL','../../helpers/testhub/constants','pipe','Percy\x20config\x20created\x20at\x20','1724110DAJvPW','stdout','689667IHWrvE','projectName','1349803jykmlz','bgqBv','error','api/app_percy/get_project_token?name=','percy.json','Percy\x20fetch\x20token\x20success','nodeRequest','start','DOWNLOAD','close','97194qAHazh','debug','automate','zpKmi','env','app:exec','QEntY','isProcessRunning','token','&type=','exec:stop','Percy\x20unable\x20to\x20fetch\x20project\x20token:\x20','hBrBB','tmpdir','YrpTR','245574rHYckW','healthcheck','getBinaryPath','./PercyBinary','4607424KRlOLD','aLRnG','flags','GeFeK','../logger','QTyro','percyOptions','Percy\x20healthcheck\x20successful','Error\x20creating\x20percy\x20config:\x20','fetchPercyToken','percy.log'];a113_0x4e41=function(){return _0x45a11d;};return a113_0x4e41();}const fs=require('fs'),path=require(a113_0x55f401(0x17c)),os=require('os'),{spawn}=require(a113_0x55f401(0x13c)),helper=require(a113_0x55f401(0x186)),logger=require(a113_0x55f401(0x170))['winstonLogger'],{getLogDir}=require('../logger'),testHubConstants=require(a113_0x55f401(0x148)),PerformanceTester=require('../../helpers/performance/performance-tester'),{PERCY_EVENTS:PerformanceEvents}=require(a113_0x55f401(0x180)),PercyBinary=require(a113_0x55f401(0x16b));class Percy{#logfile=path[a113_0x55f401(0x185)](getLogDir(),a113_0x55f401(0x176));#address=process['env'][a113_0x55f401(0x13f)]||'http://localhost:5338';#binaryPath=null;#config=null;#proc=null;#logStream=null;#isApp=![];[a113_0x55f401(0x160)]=![];constructor(_0x434ccf){const _0x2ce7d3=a113_0x55f401;this.#config=_0x434ccf,!!_0x434ccf[_0x2ce7d3(0x181)]&&(this.#isApp=!![]);}async #getBinaryPath(){const _0x53c01e=a113_0x55f401;if(!this.#binaryPath){const _0x17a842=new PercyBinary();PerformanceTester[_0x53c01e(0x156)](PerformanceEvents[_0x53c01e(0x157)]),this.#binaryPath=await _0x17a842[_0x53c01e(0x16a)](this.#config),PerformanceTester['end'](PerformanceEvents[_0x53c01e(0x157)]);}return this.#binaryPath;}async #sleep(_0x431539){return new Promise(_0x16b119=>setTimeout(_0x16b119,_0x431539));}async[a113_0x55f401(0x169)](){const _0x127d43=a113_0x55f401,_0x4cf8e7={};_0x4cf8e7[_0x127d43(0x178)]=_0x127d43(0x140),_0x4cf8e7['ETPZi']=_0x127d43(0x13d);const _0x38e988=_0x4cf8e7;try{const _0x5b8f7c=await helper[_0x127d43(0x155)](_0x38e988[_0x127d43(0x178)],_0x38e988['ETPZi'],null,null,this.#address);if(_0x5b8f7c)return!![];}catch(_0x4eae8d){return![];}}async['start'](){const _0x24277b=a113_0x55f401,_0x2a7983={'aLRnG':_0x24277b(0x15e),'LiXWS':'exec','uubIL':function(_0x5afc2c,_0x5b868b,_0x5de5f8,_0x29245e){return _0x5afc2c(_0x5b868b,_0x5de5f8,_0x29245e);},'UfRAm':_0x24277b(0x158),'bgqBv':_0x24277b(0x173)},_0x594209=await this.#getBinaryPath(),_0x2bdecb={};_0x2bdecb[_0x24277b(0x16e)]='a',this.#logStream=fs[_0x24277b(0x146)](this.#logfile,_0x2bdecb);const _0x4faa33=await this['fetchPercyToken'](),_0xd8f71b=await this[_0x24277b(0x17e)]();if(!_0x4faa33)return![];const _0x57a419=[(this.#isApp?_0x2a7983[_0x24277b(0x16d)]:_0x2a7983[_0x24277b(0x18b)])+':start'];_0xd8f71b&&_0x57a419[_0x24277b(0x143)]('-c',_0xd8f71b);this.#proc=_0x2a7983[_0x24277b(0x147)](spawn,_0x594209,_0x57a419,{'env':Object[_0x24277b(0x188)](process[_0x24277b(0x15d)],{'PERCY_TOKEN':_0x4faa33,'TH_BUILD_UUID':process['env'][testHubConstants[_0x24277b(0x184)]['BROWSERSTACK_TESTHUB_UUID']]})}),this.#proc[_0x24277b(0x14c)][_0x24277b(0x149)](this.#logStream),this.#proc[_0x24277b(0x17d)][_0x24277b(0x149)](this.#logStream),this[_0x24277b(0x160)]=!![];var _0x5ecbcc=this;this.#proc['on'](_0x2a7983[_0x24277b(0x189)],function(_0x1ff42f){const _0x4b9983=_0x24277b;_0x5ecbcc[_0x4b9983(0x160)]=![];});do{const _0x154002=await this['healthcheck']();if(_0x154002)return logger[_0x24277b(0x15a)](_0x2a7983[_0x24277b(0x150)]),!![];await this.#sleep(0x3e8);}while(this[_0x24277b(0x160)]);return![];}async[a113_0x55f401(0x17f)](){const _0x3af1ee=a113_0x55f401,_0x2bd038={'QEntY':function(_0x3fa61f,_0x1e03d8){return _0x3fa61f(_0x1e03d8);},'InemD':function(_0x140193,_0x29a4a8,_0x51d8b3){return _0x140193(_0x29a4a8,_0x51d8b3);},'CqekF':_0x3af1ee(0x163),'hBrBB':_0x3af1ee(0x158)},_0x124afa=await this.#getBinaryPath();return new Promise((_0x5d3d00,_0x1287f7)=>{const _0x4aa0d2=_0x3af1ee,_0x2b448f={'PeiiG':function(_0x3e5c53,_0x5dfb1f){const _0x52fe03=a113_0x5c99;return _0x2bd038[_0x52fe03(0x15f)](_0x3e5c53,_0x5dfb1f);}},_0x54db5b=_0x2bd038[_0x4aa0d2(0x141)](spawn,_0x124afa,[_0x2bd038[_0x4aa0d2(0x187)]]);_0x54db5b['on'](_0x2bd038[_0x4aa0d2(0x165)],_0x4bb1f7=>{this['isProcessRunning']=![],this.#logStream&&(this.#logStream['end'](),this.#logStream=null),_0x2b448f['PeiiG'](_0x5d3d00,_0x4bb1f7);});});}[a113_0x55f401(0x144)](){const _0x5a37a6=a113_0x55f401;return this[_0x5a37a6(0x160)];}async[a113_0x55f401(0x175)](){const _0x416eff=a113_0x55f401,_0x129d52={};_0x129d52[_0x416eff(0x171)]='app',_0x129d52[_0x416eff(0x13e)]=_0x416eff(0x15b),_0x129d52[_0x416eff(0x17b)]=_0x416eff(0x140),_0x129d52[_0x416eff(0x145)]=_0x416eff(0x154);const _0xf24a76=_0x129d52,_0x2944ea=this.#config[_0x416eff(0x14e)];try{const _0x5e0fb0=this.#isApp?_0xf24a76[_0x416eff(0x171)]:_0xf24a76[_0x416eff(0x13e)],_0x4fa007=await helper[_0x416eff(0x155)](_0xf24a76[_0x416eff(0x17b)],_0x416eff(0x152)+_0x2944ea+_0x416eff(0x162)+_0x5e0fb0,{},this.#config),_0x131434=_0x4fa007[_0x416eff(0x177)];return logger['debug'](_0xf24a76['qBmqj']),_0x131434[_0x416eff(0x161)];}catch(_0x5438d0){return logger[_0x416eff(0x151)](_0x416eff(0x164)+_0x5438d0),null;}}async[a113_0x55f401(0x17e)](){const _0x4b6d85=a113_0x55f401,_0x5ab389={'GeFeK':function(_0x419b72,_0x5cc6ec){return _0x419b72(_0x5cc6ec);},'NeFCn':function(_0x3584ab,_0x42ec19){return _0x3584ab+_0x42ec19;},'YrpTR':_0x4b6d85(0x14a),'TStQi':function(_0x582c84,_0x3b6447){return _0x582c84(_0x3b6447);},'zpKmi':_0x4b6d85(0x153)};if(!this.#config['percyOptions'])return null;const _0x100a51=path[_0x4b6d85(0x185)](os[_0x4b6d85(0x166)](),_0x5ab389[_0x4b6d85(0x15c)]),_0xce806b=this.#config[_0x4b6d85(0x172)];return!_0xce806b[_0x4b6d85(0x17a)]&&(_0xce806b[_0x4b6d85(0x17a)]='2'),new Promise((_0xa887ce,_0x1633e0)=>{const _0x39a956=_0x4b6d85;fs[_0x39a956(0x18a)](_0x100a51,JSON[_0x39a956(0x179)](_0xce806b),_0x388d09=>{const _0x1623ec=_0x39a956;_0x388d09&&(logger[_0x1623ec(0x151)](_0x1623ec(0x174)+_0x388d09),_0x5ab389[_0x1623ec(0x16f)](_0xa887ce,null)),logger[_0x1623ec(0x15a)](_0x5ab389['NeFCn'](_0x5ab389[_0x1623ec(0x167)],_0x100a51)),_0x5ab389['TStQi'](_0xa887ce,_0x100a51);});});}}module['exports']=Percy;