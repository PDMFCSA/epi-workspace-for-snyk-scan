const a72_0x157064=a72_0x3ca3;(function(_0xc497fe,_0x30c75c){const _0x218950=a72_0x3ca3,_0x32f293=_0xc497fe();while(!![]){try{const _0x4aabdc=-parseInt(_0x218950(0xdb))/0x1+parseInt(_0x218950(0xa8))/0x2*(-parseInt(_0x218950(0xd1))/0x3)+-parseInt(_0x218950(0xef))/0x4*(parseInt(_0x218950(0xb6))/0x5)+-parseInt(_0x218950(0xa0))/0x6+parseInt(_0x218950(0xc1))/0x7*(parseInt(_0x218950(0xa7))/0x8)+-parseInt(_0x218950(0xc3))/0x9*(-parseInt(_0x218950(0xde))/0xa)+parseInt(_0x218950(0xb1))/0xb*(parseInt(_0x218950(0xd0))/0xc);if(_0x4aabdc===_0x30c75c)break;else _0x32f293['push'](_0x32f293['shift']());}catch(_0x5781cb){_0x32f293['push'](_0x32f293['shift']());}}}(a72_0x2587,0x3d444));function a72_0x2587(){const _0x5da62a=['GET','error','DOWNLOAD','writeFile','2243328SWkzzA','70740JvBTdQ','../logger','AzpFl','mvmPZ','debug','Percy\x20fetch\x20token\x20success','fetchPercyToken','KbePS','api/app_percy/get_project_token?name=','join','207696rsGmZo','createWriteStream','push','3980wKpJpk','winstonLogger','percy.log','healthcheck','../helper','Percy\x20healthcheck\x20successful','createPercyConfig','THHnq','data','isProcessRunning','start','percy.json','EgMUv','Nvhmf','JsDSU','path','XTAbr','4MqRUpB','UbZQu','1005420YHneMd','close','isRunning','tmpdir','child_process','tRsNO','./PercyBinary','73064QmZAVj','40wpukfg','app','FIudU','token','mLybP','EsCfl','../../helpers/testhub/constants','../../helpers/performance/performance-tester','env','44ltdAxl','cKmvf','NfloL','assign','pipe','1524815yLCJjz','nodeRequest','WxgPF','stdout','ENV_VAR','getBinaryPath','projectName','YjwMm','&type=','exec:stop','percyOptions','301GvTlBl','exec','5931ySIUEv','eSjoC','app:exec','Error\x20creating\x20percy\x20config:\x20','dsEJb','automate','PERCY_SERVER_ADDRESS','stderr','ABBPn'];a72_0x2587=function(){return _0x5da62a;};return a72_0x2587();}function a72_0x3ca3(_0x5474e1,_0xbb91c9){const _0x258794=a72_0x2587();return a72_0x3ca3=function(_0x3ca39c,_0x3f5211){_0x3ca39c=_0x3ca39c-0xa0;let _0x33a530=_0x258794[_0x3ca39c];return _0x33a530;},a72_0x3ca3(_0x5474e1,_0xbb91c9);}const fs=require('fs'),path=require(a72_0x157064(0xed)),os=require('os'),{spawn}=require(a72_0x157064(0xa4)),helper=require(a72_0x157064(0xe2)),logger=require(a72_0x157064(0xd2))[a72_0x157064(0xdf)],{logDir}=require(a72_0x157064(0xd2)),testHubConstants=require(a72_0x157064(0xae)),PerformanceTester=require(a72_0x157064(0xaf)),{PERCY_EVENTS:PerformanceEvents}=require('../../helpers/performance/constants'),PercyBinary=require(a72_0x157064(0xa6));class Percy{#logfile=path['join'](logDir,a72_0x157064(0xe0));#address=process[a72_0x157064(0xb0)][a72_0x157064(0xc9)]||'http://localhost:5338';#binaryPath=null;#config=null;#proc=null;#isApp=![];[a72_0x157064(0xe7)]=![];constructor(_0x306c58){this.#config=_0x306c58,!!_0x306c58['app']&&(this.#isApp=!![]);}async #getBinaryPath(){const _0xce57a6=a72_0x157064;if(!this.#binaryPath){const _0x27a47e=new PercyBinary();PerformanceTester[_0xce57a6(0xe8)](PerformanceEvents[_0xce57a6(0xce)]),this.#binaryPath=await _0x27a47e[_0xce57a6(0xbb)](this.#config),PerformanceTester['end'](PerformanceEvents[_0xce57a6(0xce)]);}return this.#binaryPath;}async #sleep(_0x3696fb){return new Promise(_0x1eaf6e=>setTimeout(_0x1eaf6e,_0x3696fb));}async[a72_0x157064(0xe1)](){const _0x456c15=a72_0x157064,_0x571399={};_0x571399[_0x456c15(0xee)]=_0x456c15(0xcc),_0x571399[_0x456c15(0xc4)]='percy/healthcheck';const _0x451b89=_0x571399;try{const _0x2a9f76=await helper[_0x456c15(0xb7)](_0x451b89[_0x456c15(0xee)],_0x451b89[_0x456c15(0xc4)],null,null,this.#address);if(_0x2a9f76)return!![];}catch(_0x24bc74){return![];}}async['start'](){const _0x4571b9=a72_0x157064,_0x95822e={'AzpFl':_0x4571b9(0xc5),'CIFcT':_0x4571b9(0xc2),'FIudU':function(_0x572a4a,_0x42fe43,_0x1dc859,_0x290e0d){return _0x572a4a(_0x42fe43,_0x1dc859,_0x290e0d);},'MRGZs':_0x4571b9(0xa1),'EsCfl':_0x4571b9(0xe3)},_0x3e1400=await this.#getBinaryPath(),_0x1670e2={};_0x1670e2['flags']='a';const _0x127f79=fs[_0x4571b9(0xdc)](this.#logfile,_0x1670e2),_0x4a01c6=await this['fetchPercyToken'](),_0x564533=await this[_0x4571b9(0xe4)]();if(!_0x4a01c6)return![];const _0x5101b5=[(this.#isApp?_0x95822e[_0x4571b9(0xd3)]:_0x95822e['CIFcT'])+':start'];_0x564533&&_0x5101b5[_0x4571b9(0xdd)]('-c',_0x564533);this.#proc=_0x95822e[_0x4571b9(0xaa)](spawn,_0x3e1400,_0x5101b5,{'env':Object[_0x4571b9(0xb4)](process['env'],{'PERCY_TOKEN':_0x4a01c6,'TH_BUILD_UUID':process[_0x4571b9(0xb0)][testHubConstants[_0x4571b9(0xba)]['BROWSERSTACK_TESTHUB_UUID']]})}),this.#proc[_0x4571b9(0xb9)][_0x4571b9(0xb5)](_0x127f79),this.#proc[_0x4571b9(0xca)][_0x4571b9(0xb5)](_0x127f79),this[_0x4571b9(0xe7)]=!![];var _0x380655=this;this.#proc['on'](_0x95822e['MRGZs'],function(_0x4cdf6b){_0x380655['isProcessRunning']=![];});do{const _0x1c2abf=await this[_0x4571b9(0xe1)]();if(_0x1c2abf)return logger[_0x4571b9(0xd5)](_0x95822e[_0x4571b9(0xad)]),!![];await this.#sleep(0x3e8);}while(this['isProcessRunning']);return![];}async['stop'](){const _0xbbe698=a72_0x157064,_0x123197={'WxgPF':function(_0x15822c,_0x5de252){return _0x15822c(_0x5de252);},'UbZQu':function(_0x24faf2,_0x210b8b,_0xed0bb2){return _0x24faf2(_0x210b8b,_0xed0bb2);},'YjwMm':_0xbbe698(0xbf),'NfloL':_0xbbe698(0xa1)},_0xf52d1=await this.#getBinaryPath();return new Promise((_0x4014e6,_0x3aaaa0)=>{const _0x18e488=_0xbbe698,_0x1e2d82=_0x123197[_0x18e488(0xf0)](spawn,_0xf52d1,[_0x123197[_0x18e488(0xbd)]]);_0x1e2d82['on'](_0x123197[_0x18e488(0xb3)],_0x4ab11=>{const _0x26bf53=_0x18e488;this['isProcessRunning']=![],_0x123197[_0x26bf53(0xb8)](_0x4014e6,_0x4ab11);});});}[a72_0x157064(0xa2)](){const _0x50624c=a72_0x157064;return this[_0x50624c(0xe7)];}async[a72_0x157064(0xd7)](){const _0x1f9546=a72_0x157064,_0x44fba8={};_0x44fba8['Nvhmf']=_0x1f9546(0xa9),_0x44fba8[_0x1f9546(0xd4)]=_0x1f9546(0xc8),_0x44fba8[_0x1f9546(0xb2)]=_0x1f9546(0xcc),_0x44fba8[_0x1f9546(0xa5)]=_0x1f9546(0xd6);const _0x520609=_0x44fba8,_0x3b2f6b=this.#config[_0x1f9546(0xbc)];try{const _0x2e8fd7=this.#isApp?_0x520609[_0x1f9546(0xeb)]:_0x520609[_0x1f9546(0xd4)],_0x2bfe0c=await helper['nodeRequest'](_0x520609['cKmvf'],_0x1f9546(0xd9)+_0x3b2f6b+_0x1f9546(0xbe)+_0x2e8fd7,{},this.#config),_0x1361f2=_0x2bfe0c[_0x1f9546(0xe6)];return logger[_0x1f9546(0xd5)](_0x520609[_0x1f9546(0xa5)]),_0x1361f2[_0x1f9546(0xab)];}catch(_0x5d2f39){return logger['error']('Percy\x20unable\x20to\x20fetch\x20project\x20token:\x20'+_0x5d2f39),null;}}async[a72_0x157064(0xe4)](){const _0x36f339=a72_0x157064,_0x399fb8={'EgMUv':function(_0x3c6bce,_0x3941bd){return _0x3c6bce(_0x3941bd);},'ABBPn':function(_0x487fd9,_0x4119fd){return _0x487fd9+_0x4119fd;},'onJQt':'Percy\x20config\x20created\x20at\x20','dsEJb':function(_0x9a290f,_0x329473){return _0x9a290f(_0x329473);},'mLybP':_0x36f339(0xe9)};if(!this.#config['percyOptions'])return null;const _0x107ca9=path[_0x36f339(0xda)](os[_0x36f339(0xa3)](),_0x399fb8[_0x36f339(0xac)]),_0x3cff2c=this.#config[_0x36f339(0xc0)];return!_0x3cff2c['version']&&(_0x3cff2c['version']='2'),new Promise((_0x443e9f,_0x5b10e9)=>{const _0x54d6b1=_0x36f339,_0xf92bcd={'RGuro':function(_0x272441,_0x5dc11b){const _0x5e2073=a72_0x3ca3;return _0x399fb8[_0x5e2073(0xea)](_0x272441,_0x5dc11b);},'THHnq':function(_0x15fad7,_0x365869){const _0xba7d81=a72_0x3ca3;return _0x399fb8[_0xba7d81(0xcb)](_0x15fad7,_0x365869);},'JsDSU':_0x399fb8['onJQt'],'KbePS':function(_0x293e13,_0x56ec10){const _0x35342e=a72_0x3ca3;return _0x399fb8[_0x35342e(0xc7)](_0x293e13,_0x56ec10);}};fs[_0x54d6b1(0xcf)](_0x107ca9,JSON['stringify'](_0x3cff2c),_0x4796c6=>{const _0x44b596=_0x54d6b1;_0x4796c6&&(logger[_0x44b596(0xcd)](_0x44b596(0xc6)+_0x4796c6),_0xf92bcd['RGuro'](_0x443e9f,null)),logger['debug'](_0xf92bcd[_0x44b596(0xe5)](_0xf92bcd[_0x44b596(0xec)],_0x107ca9)),_0xf92bcd[_0x44b596(0xd8)](_0x443e9f,_0x107ca9);});});}}module['exports']=Percy;