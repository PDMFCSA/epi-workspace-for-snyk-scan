const a113_0x40a057=a113_0x4d8b;function a113_0x461f(){const _0x55e647=['../logger','percy/healthcheck','244GGZSQq','DOWNLOAD','vTXoS','../../helpers/performance/constants','cmQxr','api/app_percy/get_project_token?name=','createPercyConfig','assign','stdout','hbulz','Percy\x20config\x20created\x20at\x20','ENV_VAR','child_process','debug','fetchPercyToken','BROWSERSTACK_TESTHUB_UUID','Percy\x20healthcheck\x20successful','data','Mtgwa','CBeHG','7FBKRJb','../../helpers/testhub/constants','createWriteStream','673792QCjVRz','projectName','qJTPz','PDPJV','PERCY_SERVER_ADDRESS','Percy\x20fetch\x20token\x20success','app:exec','flags','mCawj','stderr','ODMUJ','4394916NCxmBR','winstonLogger','version','dbOsv','&type=','nodeRequest','lPJtz','env','exec','AjCaU','27CqhqNZ','percyOptions','isProcessRunning','exec:stop','3fEeXZQ','MqcIO','../helper','error','healthcheck','5531152ubzBQV','XzvKQ','end','wLSRP','5615872zrPiXI','stop','ilEgQ','join','app','ZYeJl','pipe','start','percy.log','close','writeFile','../../helpers/performance/performance-tester','115078akeQKR','2202400JRkkXo','ttPNS',':start','12415PMsRWv'];a113_0x461f=function(){return _0x55e647;};return a113_0x461f();}(function(_0x30622e,_0x17eab0){const _0x379642=a113_0x4d8b,_0x3ece08=_0x30622e();while(!![]){try{const _0x1dc8b1=-parseInt(_0x379642(0xe7))/0x1+-parseInt(_0x379642(0xc9))/0x2*(-parseInt(_0x379642(0xb4))/0x3)+-parseInt(_0x379642(0xd0))/0x4*(parseInt(_0x379642(0xcd))/0x5)+parseInt(_0x379642(0xf2))/0x6+parseInt(_0x379642(0xe4))/0x7*(-parseInt(_0x379642(0xbd))/0x8)+parseInt(_0x379642(0xb0))/0x9*(parseInt(_0x379642(0xca))/0xa)+parseInt(_0x379642(0xb9))/0xb;if(_0x1dc8b1===_0x17eab0)break;else _0x3ece08['push'](_0x3ece08['shift']());}catch(_0x524c08){_0x3ece08['push'](_0x3ece08['shift']());}}}(a113_0x461f,0x68162));const fs=require('fs'),path=require('path'),os=require('os'),{spawn}=require(a113_0x40a057(0xdc)),helper=require(a113_0x40a057(0xb6)),logger=require(a113_0x40a057(0xce))[a113_0x40a057(0xf3)],{getLogDir}=require(a113_0x40a057(0xce)),testHubConstants=require(a113_0x40a057(0xe5)),PerformanceTester=require(a113_0x40a057(0xc8)),{PERCY_EVENTS:PerformanceEvents}=require(a113_0x40a057(0xd3)),PercyBinary=require('./PercyBinary');function a113_0x4d8b(_0x56114c,_0x4b1529){const _0x461f47=a113_0x461f();return a113_0x4d8b=function(_0x4d8b9b,_0x5d5c3d){_0x4d8b9b=_0x4d8b9b-0xad;let _0xc14764=_0x461f47[_0x4d8b9b];return _0xc14764;},a113_0x4d8b(_0x56114c,_0x4b1529);}class Percy{#logfile=path['join'](getLogDir(),a113_0x40a057(0xc5));#address=process[a113_0x40a057(0xad)][a113_0x40a057(0xeb)]||'http://localhost:5338';#binaryPath=null;#config=null;#proc=null;#logStream=null;#isApp=![];[a113_0x40a057(0xb2)]=![];constructor(_0xe3437c){const _0x550035=a113_0x40a057;this.#config=_0xe3437c,!!_0xe3437c[_0x550035(0xc1)]&&(this.#isApp=!![]);}async #getBinaryPath(){const _0x43c561=a113_0x40a057;if(!this.#binaryPath){const _0x27bb5a=new PercyBinary();PerformanceTester[_0x43c561(0xc4)](PerformanceEvents[_0x43c561(0xd1)]),this.#binaryPath=await _0x27bb5a['getBinaryPath'](this.#config),PerformanceTester[_0x43c561(0xbb)](PerformanceEvents[_0x43c561(0xd1)]);}return this.#binaryPath;}async #sleep(_0x4387e7){return new Promise(_0x1c577c=>setTimeout(_0x1c577c,_0x4387e7));}async[a113_0x40a057(0xb8)](){const _0x2ac35c=a113_0x40a057,_0x39b120={};_0x39b120[_0x2ac35c(0xef)]='GET',_0x39b120[_0x2ac35c(0xd2)]=_0x2ac35c(0xcf);const _0x79a062=_0x39b120;try{const _0x1f8606=await helper[_0x2ac35c(0xf7)](_0x79a062[_0x2ac35c(0xef)],_0x79a062[_0x2ac35c(0xd2)],null,null,this.#address);if(_0x1f8606)return!![];}catch(_0x3ba8c9){return![];}}async['start'](){const _0x51443f=a113_0x40a057,_0x202885={'wLSRP':_0x51443f(0xed),'ilEgQ':_0x51443f(0xae),'AjCaU':function(_0x2849bc,_0x101afc,_0x44f973,_0x1431a5){return _0x2849bc(_0x101afc,_0x44f973,_0x1431a5);},'ttPNS':_0x51443f(0xc6),'dbOsv':_0x51443f(0xe0)},_0x17fb51=await this.#getBinaryPath(),_0x1fa183={};_0x1fa183[_0x51443f(0xee)]='a',this.#logStream=fs[_0x51443f(0xe6)](this.#logfile,_0x1fa183);const _0x3ecadc=await this[_0x51443f(0xde)](),_0x2098bf=await this[_0x51443f(0xd6)]();if(!_0x3ecadc)return![];const _0x5c4b81=[(this.#isApp?_0x202885[_0x51443f(0xbc)]:_0x202885[_0x51443f(0xbf)])+_0x51443f(0xcc)];_0x2098bf&&_0x5c4b81['push']('-c',_0x2098bf);this.#proc=_0x202885[_0x51443f(0xaf)](spawn,_0x17fb51,_0x5c4b81,{'env':Object[_0x51443f(0xd7)](process['env'],{'PERCY_TOKEN':_0x3ecadc,'TH_BUILD_UUID':process['env'][testHubConstants[_0x51443f(0xdb)][_0x51443f(0xdf)]]})}),this.#proc[_0x51443f(0xd8)][_0x51443f(0xc3)](this.#logStream),this.#proc[_0x51443f(0xf0)][_0x51443f(0xc3)](this.#logStream),this[_0x51443f(0xb2)]=!![];var _0x39acc1=this;this.#proc['on'](_0x202885[_0x51443f(0xcb)],function(_0x571364){_0x39acc1['isProcessRunning']=![];});do{const _0x311c9d=await this['healthcheck']();if(_0x311c9d)return logger[_0x51443f(0xdd)](_0x202885[_0x51443f(0xf5)]),!![];await this.#sleep(0x3e8);}while(this[_0x51443f(0xb2)]);return![];}async[a113_0x40a057(0xbe)](){const _0x238965=a113_0x40a057,_0x26bcdb={'jiANq':function(_0x4631c1,_0x2536f5){return _0x4631c1(_0x2536f5);},'cmQxr':function(_0x1bc80f,_0x2b91e2,_0x3ab348){return _0x1bc80f(_0x2b91e2,_0x3ab348);},'PPBHh':_0x238965(0xb3),'qJTPz':_0x238965(0xc6)},_0x5a5668=await this.#getBinaryPath();return new Promise((_0x430c0b,_0x145862)=>{const _0x19ac9e=_0x238965,_0x213c08=_0x26bcdb[_0x19ac9e(0xd4)](spawn,_0x5a5668,[_0x26bcdb['PPBHh']]);_0x213c08['on'](_0x26bcdb[_0x19ac9e(0xe9)],_0xa2c774=>{const _0x16ed74=_0x19ac9e;this[_0x16ed74(0xb2)]=![],this.#logStream&&(this.#logStream['end'](),this.#logStream=null),_0x26bcdb['jiANq'](_0x430c0b,_0xa2c774);});});}['isRunning'](){const _0x210c7e=a113_0x40a057;return this[_0x210c7e(0xb2)];}async['fetchPercyToken'](){const _0x686335=a113_0x40a057,_0x22b7ed={};_0x22b7ed[_0x686335(0xb5)]=_0x686335(0xc1),_0x22b7ed[_0x686335(0xba)]='automate',_0x22b7ed['xuvKq']='GET',_0x22b7ed[_0x686335(0xf8)]=_0x686335(0xec);const _0x502661=_0x22b7ed,_0x5f32d7=this.#config[_0x686335(0xe8)];try{const _0x33aafb=this.#isApp?_0x502661['MqcIO']:_0x502661[_0x686335(0xba)],_0x5b801d=await helper[_0x686335(0xf7)](_0x502661['xuvKq'],_0x686335(0xd5)+_0x5f32d7+_0x686335(0xf6)+_0x33aafb,{},this.#config),_0x586d42=_0x5b801d[_0x686335(0xe1)];return logger['debug'](_0x502661[_0x686335(0xf8)]),_0x586d42['token'];}catch(_0x3e7174){return logger[_0x686335(0xb7)]('Percy\x20unable\x20to\x20fetch\x20project\x20token:\x20'+_0x3e7174),null;}}async['createPercyConfig'](){const _0x49455e=a113_0x40a057,_0x5f5d6c={'hbulz':function(_0x20dc44,_0x334f2d){return _0x20dc44(_0x334f2d);},'Mtgwa':function(_0xf33401,_0x160c23){return _0xf33401+_0x160c23;},'ODMUJ':_0x49455e(0xda),'ZYeJl':'percy.json'};if(!this.#config[_0x49455e(0xb1)])return null;const _0x3a440d=path[_0x49455e(0xc0)](os['tmpdir'](),_0x5f5d6c[_0x49455e(0xc2)]),_0x3a6d06=this.#config[_0x49455e(0xb1)];return!_0x3a6d06['version']&&(_0x3a6d06[_0x49455e(0xf4)]='2'),new Promise((_0x495ea3,_0x54c3b7)=>{const _0x28d879=_0x49455e,_0x40ec4f={'CBeHG':function(_0x36d4f9,_0x2fb264){const _0x4d0b96=a113_0x4d8b;return _0x5f5d6c[_0x4d0b96(0xd9)](_0x36d4f9,_0x2fb264);},'PDPJV':function(_0x5edb7a,_0x1d4360){const _0x28c121=a113_0x4d8b;return _0x5f5d6c[_0x28c121(0xe2)](_0x5edb7a,_0x1d4360);},'nSYBn':_0x5f5d6c[_0x28d879(0xf1)]};fs[_0x28d879(0xc7)](_0x3a440d,JSON['stringify'](_0x3a6d06),_0x3caf5c=>{const _0x335efd=_0x28d879;_0x3caf5c&&(logger[_0x335efd(0xb7)]('Error\x20creating\x20percy\x20config:\x20'+_0x3caf5c),_0x40ec4f[_0x335efd(0xe3)](_0x495ea3,null)),logger[_0x335efd(0xdd)](_0x40ec4f[_0x335efd(0xea)](_0x40ec4f['nSYBn'],_0x3a440d)),_0x40ec4f[_0x335efd(0xe3)](_0x495ea3,_0x3a440d);});});}}module['exports']=Percy;