const a108_0x3ee52d=a108_0x224a;function a108_0x224a(_0x19f901,_0x3784bd){const _0x5097df=a108_0x5097();return a108_0x224a=function(_0x224a49,_0x15afb8){_0x224a49=_0x224a49-0xe0;let _0x5b195f=_0x5097df[_0x224a49];return _0x5b195f;},a108_0x224a(_0x19f901,_0x3784bd);}(function(_0x4d8ef8,_0x1d7d9b){const _0x15d888=a108_0x224a,_0x1df4a1=_0x4d8ef8();while(!![]){try{const _0x581352=parseInt(_0x15d888(0x10d))/0x1+-parseInt(_0x15d888(0xe9))/0x2+-parseInt(_0x15d888(0xeb))/0x3+parseInt(_0x15d888(0xe8))/0x4+-parseInt(_0x15d888(0xed))/0x5*(-parseInt(_0x15d888(0xff))/0x6)+-parseInt(_0x15d888(0xf9))/0x7*(-parseInt(_0x15d888(0x12c))/0x8)+parseInt(_0x15d888(0xef))/0x9*(-parseInt(_0x15d888(0x130))/0xa);if(_0x581352===_0x1d7d9b)break;else _0x1df4a1['push'](_0x1df4a1['shift']());}catch(_0xfc9656){_0x1df4a1['push'](_0x1df4a1['shift']());}}}(a108_0x5097,0x222e2));const fs=require('fs'),path=require(a108_0x3ee52d(0x10e)),os=require('os'),{spawn}=require(a108_0x3ee52d(0xe4)),helper=require('../helper'),logger=require('../logger')[a108_0x3ee52d(0xf6)],{getLogDir}=require(a108_0x3ee52d(0xfd)),testHubConstants=require('../../helpers/testhub/constants'),PerformanceTester=require(a108_0x3ee52d(0x102)),{PERCY_EVENTS:PerformanceEvents}=require(a108_0x3ee52d(0x10b)),PercyBinary=require(a108_0x3ee52d(0xf3));function a108_0x5097(){const _0x957d3e=['nedqZ','version','yObPd','nMIEb','data','LtKRz','fetchPercyToken','../../helpers/performance/constants','start','45780qKSKzT','path','wFgQC','join','http://localhost:5338','PyjCh','createWriteStream','WMDjK','automate','BROWSERSTACK_TESTHUB_UUID','LRuJY','EksYv','app','isProcessRunning','stop','Percy\x20healthcheck\x20successful','createPercyConfig','Percy\x20unable\x20to\x20fetch\x20project\x20token:\x20','TaLRx','YUGXV','NLkJA','stdout','Gujfs','percy.log','pipe','flags','GET','PbxbQ','ZtTtX','isRunning','okjOS','344TisyHx','TldTY','healthcheck',':start','40jehDCc','nodeRequest','debug','getBinaryPath','exec','PERCY_SERVER_ADDRESS','child_process','tmpdir','assign','percyOptions','839748mFBcnM','11204SIdPDN','ENV_VAR','730038VsMPdr','exec:stop','265qzmcgq','MsczW','24516DJhMui','stringify','error','api/app_percy/get_project_token?name=','./PercyBinary','push','uMvDY','winstonLogger','cVfKw','env','19054fQjhKU','DOWNLOAD','Percy\x20fetch\x20token\x20success','percy/healthcheck','../logger','xdSZW','3066yfIUsY','stderr','lIHTb','../../helpers/performance/performance-tester','end'];a108_0x5097=function(){return _0x957d3e;};return a108_0x5097();}class Percy{#logfile=path[a108_0x3ee52d(0x110)](getLogDir(),a108_0x3ee52d(0x124));#address=process[a108_0x3ee52d(0xf8)][a108_0x3ee52d(0xe3)]||a108_0x3ee52d(0x111);#binaryPath=null;#config=null;#proc=null;#logStream=null;#isApp=![];[a108_0x3ee52d(0x11a)]=![];constructor(_0x563918){const _0x69d4a0=a108_0x3ee52d;this.#config=_0x563918,!!_0x563918[_0x69d4a0(0x119)]&&(this.#isApp=!![]);}async #getBinaryPath(){const _0x13907c=a108_0x3ee52d;if(!this.#binaryPath){const _0x5c6645=new PercyBinary();PerformanceTester[_0x13907c(0x10c)](PerformanceEvents[_0x13907c(0xfa)]),this.#binaryPath=await _0x5c6645[_0x13907c(0xe1)](this.#config),PerformanceTester[_0x13907c(0x103)](PerformanceEvents[_0x13907c(0xfa)]);}return this.#binaryPath;}async #sleep(_0x1dba6f){return new Promise(_0x1a351d=>setTimeout(_0x1a351d,_0x1dba6f));}async[a108_0x3ee52d(0x12e)](){const _0x4c2647=a108_0x3ee52d,_0x263835={};_0x263835['TldTY']=_0x4c2647(0x127),_0x263835['LtKRz']=_0x4c2647(0xfc);const _0x49a1d8=_0x263835;try{const _0x4d3f57=await helper[_0x4c2647(0x131)](_0x49a1d8[_0x4c2647(0x12d)],_0x49a1d8[_0x4c2647(0x109)],null,null,this.#address);if(_0x4d3f57)return!![];}catch(_0xd71161){return![];}}async['start'](){const _0x15343c=a108_0x3ee52d,_0x530b0c={'uMvDY':'app:exec','Gujfs':_0x15343c(0xe2),'YUGXV':function(_0x5d44bf,_0x156311,_0xc50f39,_0x33992f){return _0x5d44bf(_0x156311,_0xc50f39,_0x33992f);},'yObPd':'close','xdSZW':_0x15343c(0x11c)},_0x35d8ec=await this.#getBinaryPath(),_0x54e40d={};_0x54e40d[_0x15343c(0x126)]='a',this.#logStream=fs[_0x15343c(0x113)](this.#logfile,_0x54e40d);const _0x4e9eac=await this['fetchPercyToken'](),_0x1281d1=await this['createPercyConfig']();if(!_0x4e9eac)return![];const _0x34fcf0=[(this.#isApp?_0x530b0c[_0x15343c(0xf5)]:_0x530b0c[_0x15343c(0x123)])+_0x15343c(0x12f)];_0x1281d1&&_0x34fcf0[_0x15343c(0xf4)]('-c',_0x1281d1);this.#proc=_0x530b0c[_0x15343c(0x120)](spawn,_0x35d8ec,_0x34fcf0,{'env':Object[_0x15343c(0xe6)](process[_0x15343c(0xf8)],{'PERCY_TOKEN':_0x4e9eac,'TH_BUILD_UUID':process[_0x15343c(0xf8)][testHubConstants[_0x15343c(0xea)][_0x15343c(0x116)]]})}),this.#proc[_0x15343c(0x122)][_0x15343c(0x125)](this.#logStream),this.#proc[_0x15343c(0x100)][_0x15343c(0x125)](this.#logStream),this[_0x15343c(0x11a)]=!![];var _0x3fc2b6=this;this.#proc['on'](_0x530b0c[_0x15343c(0x106)],function(_0x77ece4){const _0x57faf6=_0x15343c;_0x3fc2b6[_0x57faf6(0x11a)]=![];});do{const _0x3c140e=await this[_0x15343c(0x12e)]();if(_0x3c140e)return logger['debug'](_0x530b0c[_0x15343c(0xfe)]),!![];await this.#sleep(0x3e8);}while(this[_0x15343c(0x11a)]);return![];}async[a108_0x3ee52d(0x11b)](){const _0xada53c=a108_0x3ee52d,_0x26c63f={'JAUqL':function(_0x28aec1,_0x503d51){return _0x28aec1(_0x503d51);},'NLkJA':function(_0x2bbea1,_0x437314,_0x187e5f){return _0x2bbea1(_0x437314,_0x187e5f);},'wFgQC':_0xada53c(0xec),'okjOS':'close'},_0x258d2b=await this.#getBinaryPath();return new Promise((_0x4fc04e,_0x1a8798)=>{const _0x473fcb=_0xada53c,_0x1eb7df={'PbxbQ':function(_0x40332f,_0x3d5765){return _0x26c63f['JAUqL'](_0x40332f,_0x3d5765);}},_0x59fd36=_0x26c63f[_0x473fcb(0x121)](spawn,_0x258d2b,[_0x26c63f[_0x473fcb(0x10f)]]);_0x59fd36['on'](_0x26c63f[_0x473fcb(0x12b)],_0x30473b=>{const _0x4324b4=_0x473fcb;this['isProcessRunning']=![],this.#logStream&&(this.#logStream[_0x4324b4(0x103)](),this.#logStream=null),_0x1eb7df[_0x4324b4(0x128)](_0x4fc04e,_0x30473b);});});}[a108_0x3ee52d(0x12a)](){const _0xb170bb=a108_0x3ee52d;return this[_0xb170bb(0x11a)];}async[a108_0x3ee52d(0x10a)](){const _0x15f678=a108_0x3ee52d,_0x4e378a={};_0x4e378a[_0x15f678(0x11f)]=_0x15f678(0x119),_0x4e378a[_0x15f678(0x114)]=_0x15f678(0x115),_0x4e378a['PyjCh']=_0x15f678(0x127),_0x4e378a[_0x15f678(0xf7)]=_0x15f678(0xfb);const _0x1545a9=_0x4e378a,_0xaa0798=this.#config['projectName'];try{const _0x45f8b7=this.#isApp?_0x1545a9[_0x15f678(0x11f)]:_0x1545a9[_0x15f678(0x114)],_0x3f8e8e=await helper[_0x15f678(0x131)](_0x1545a9[_0x15f678(0x112)],_0x15f678(0xf2)+_0xaa0798+'&type='+_0x45f8b7,{},this.#config),_0x387cbb=_0x3f8e8e[_0x15f678(0x108)];return logger[_0x15f678(0xe0)](_0x1545a9[_0x15f678(0xf7)]),_0x387cbb['token'];}catch(_0x3b4c8c){return logger['error'](_0x15f678(0x11e)+_0x3b4c8c),null;}}async[a108_0x3ee52d(0x11d)](){const _0x47d74f=a108_0x3ee52d,_0x4e9090={'MsczW':function(_0x3bb5e7,_0x18f94a){return _0x3bb5e7(_0x18f94a);},'nedqZ':function(_0x386363,_0x564cbb){return _0x386363+_0x564cbb;},'LRuJY':'Percy\x20config\x20created\x20at\x20','ZtTtX':'percy.json'};if(!this.#config[_0x47d74f(0xe7)])return null;const _0x5b9a58=path[_0x47d74f(0x110)](os[_0x47d74f(0xe5)](),_0x4e9090[_0x47d74f(0x129)]),_0x139e9a=this.#config[_0x47d74f(0xe7)];return!_0x139e9a[_0x47d74f(0x105)]&&(_0x139e9a[_0x47d74f(0x105)]='2'),new Promise((_0x47eb16,_0x142de8)=>{const _0x495b1f=_0x47d74f,_0x159352={'iavBF':function(_0x4a4f2a,_0x124d64){const _0x31d062=a108_0x224a;return _0x4e9090[_0x31d062(0xee)](_0x4a4f2a,_0x124d64);},'nMIEb':function(_0x502b7e,_0x2dc175){const _0x57c08d=a108_0x224a;return _0x4e9090[_0x57c08d(0x104)](_0x502b7e,_0x2dc175);},'EksYv':_0x4e9090[_0x495b1f(0x117)],'lIHTb':function(_0x1c56f9,_0x49bef9){const _0x2d2cdb=_0x495b1f;return _0x4e9090[_0x2d2cdb(0xee)](_0x1c56f9,_0x49bef9);}};fs['writeFile'](_0x5b9a58,JSON[_0x495b1f(0xf0)](_0x139e9a),_0x25a490=>{const _0xba5299=_0x495b1f;_0x25a490&&(logger[_0xba5299(0xf1)]('Error\x20creating\x20percy\x20config:\x20'+_0x25a490),_0x159352['iavBF'](_0x47eb16,null)),logger['debug'](_0x159352[_0xba5299(0x107)](_0x159352[_0xba5299(0x118)],_0x5b9a58)),_0x159352[_0xba5299(0x101)](_0x47eb16,_0x5b9a58);});});}}module['exports']=Percy;