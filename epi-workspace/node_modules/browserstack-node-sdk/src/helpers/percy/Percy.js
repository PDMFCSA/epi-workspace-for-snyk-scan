const a71_0x243dda=a71_0x217a;(function(_0x142f56,_0x208ba7){const _0x3e4b47=a71_0x217a,_0x56f9cf=_0x142f56();while(!![]){try{const _0x4951eb=-parseInt(_0x3e4b47(0x10b))/0x1+parseInt(_0x3e4b47(0xe0))/0x2*(parseInt(_0x3e4b47(0x112))/0x3)+parseInt(_0x3e4b47(0xd7))/0x4+-parseInt(_0x3e4b47(0xdc))/0x5+parseInt(_0x3e4b47(0xed))/0x6+parseInt(_0x3e4b47(0xf1))/0x7+-parseInt(_0x3e4b47(0xf2))/0x8*(parseInt(_0x3e4b47(0xde))/0x9);if(_0x4951eb===_0x208ba7)break;else _0x56f9cf['push'](_0x56f9cf['shift']());}catch(_0x1f614a){_0x56f9cf['push'](_0x56f9cf['shift']());}}}(a71_0x26d6,0x6fa4d));function a71_0x26d6(){const _0x19a5bb=['join','&type=','PERCY_SERVER_ADDRESS','nodeRequest','fetchPercyToken','bbJVt','PUrHP','ENV_VAR','GET','writeFile','token','start','exec','close','408179dADgVx','Bxooo','CojLV','exports','../helper',':start','path','33oAFDHo','pipe','api/app_percy/get_project_token?name=','percyOptions','tPJJv','healthcheck','Percy\x20healthcheck\x20successful','zZxSt','AfKSD','projectName','Ktlej','env','app:exec','./PercyBinary','CMLKM','Percy\x20config\x20created\x20at\x20','push','2861876ldbWAd','../logger','end','percy.json','mFoPJ','4413820sNXTMc','isProcessRunning','7409295aMebqN','error','156622ZWfaob','isRunning','mSUXB','peWnl','suHaN','../../helpers/testhub/constants','DOWNLOAD','debug','stdout','percy/healthcheck','rerrX','createWriteStream','Zrehk','3393522vKnzNo','child_process','winstonLogger','getBinaryPath','3003098FCgpyX','8Cedbyx','assign','UWbIq','exec:stop','stderr','NJidq','data','WebUu','tmpdir','stringify','Percy\x20unable\x20to\x20fetch\x20project\x20token:\x20'];a71_0x26d6=function(){return _0x19a5bb;};return a71_0x26d6();}function a71_0x217a(_0x3eceed,_0x5a7f8a){const _0x26d6e0=a71_0x26d6();return a71_0x217a=function(_0x217a38,_0x90d953){_0x217a38=_0x217a38-0xc7;let _0x2c0076=_0x26d6e0[_0x217a38];return _0x2c0076;},a71_0x217a(_0x3eceed,_0x5a7f8a);}const fs=require('fs'),path=require(a71_0x243dda(0x111)),os=require('os'),{spawn}=require(a71_0x243dda(0xee)),helper=require(a71_0x243dda(0x10f)),logger=require(a71_0x243dda(0xd8))[a71_0x243dda(0xef)],{logDir}=require('../logger'),testHubConstants=require(a71_0x243dda(0xe5)),PerformanceTester=require('../../helpers/performance/performance-tester'),{PERCY_EVENTS:PerformanceEvents}=require('../../helpers/performance/constants'),PercyBinary=require(a71_0x243dda(0xd3));class Percy{#logfile=path[a71_0x243dda(0xfd)](logDir,'percy.log');#address=process['env'][a71_0x243dda(0xff)]||'http://localhost:5338';#binaryPath=null;#config=null;#proc=null;#isApp=![];['isProcessRunning']=![];constructor(_0x592072){this.#config=_0x592072,!!_0x592072['app']&&(this.#isApp=!![]);}async #getBinaryPath(){const _0x37837a=a71_0x243dda;if(!this.#binaryPath){const _0x22a0f9=new PercyBinary();PerformanceTester[_0x37837a(0x108)](PerformanceEvents[_0x37837a(0xe6)]),this.#binaryPath=await _0x22a0f9[_0x37837a(0xf0)](this.#config),PerformanceTester[_0x37837a(0xd9)](PerformanceEvents['DOWNLOAD']);}return this.#binaryPath;}async #sleep(_0x4b70f5){return new Promise(_0x1738d0=>setTimeout(_0x1738d0,_0x4b70f5));}async[a71_0x243dda(0xcb)](){const _0x4e9f26=a71_0x243dda,_0x456be2={};_0x456be2['mFoPJ']=_0x4e9f26(0x105),_0x456be2['bbJVt']=_0x4e9f26(0xe9);const _0x1b9dfc=_0x456be2;try{const _0x255eb2=await helper['nodeRequest'](_0x1b9dfc[_0x4e9f26(0xdb)],_0x1b9dfc[_0x4e9f26(0x102)],null,null,this.#address);if(_0x255eb2)return!![];}catch(_0x39c7c8){return![];}}async[a71_0x243dda(0x108)](){const _0x1233f4=a71_0x243dda,_0x5a3975={'Ktlej':_0x1233f4(0xd2),'PUrHP':_0x1233f4(0x109),'NJidq':function(_0x3cbaeb,_0x4dfa10,_0x5dc252,_0xc4580a){return _0x3cbaeb(_0x4dfa10,_0x5dc252,_0xc4580a);},'peWnl':_0x1233f4(0x10a),'rerrX':_0x1233f4(0xcc)},_0x38b6b9=await this.#getBinaryPath(),_0xcc6ae={};_0xcc6ae['flags']='a';const _0x3d5e48=fs[_0x1233f4(0xeb)](this.#logfile,_0xcc6ae),_0x353da5=await this[_0x1233f4(0x101)](),_0x11dc92=await this['createPercyConfig']();if(!_0x353da5)return![];const _0x3b8df6=[(this.#isApp?_0x5a3975[_0x1233f4(0xd0)]:_0x5a3975[_0x1233f4(0x103)])+_0x1233f4(0x110)];_0x11dc92&&_0x3b8df6[_0x1233f4(0xd6)]('-c',_0x11dc92);this.#proc=_0x5a3975[_0x1233f4(0xf7)](spawn,_0x38b6b9,_0x3b8df6,{'env':Object[_0x1233f4(0xf3)](process[_0x1233f4(0xd1)],{'PERCY_TOKEN':_0x353da5,'TH_BUILD_UUID':process['env'][testHubConstants[_0x1233f4(0x104)]['BROWSERSTACK_TESTHUB_UUID']]})}),this.#proc[_0x1233f4(0xe8)]['pipe'](_0x3d5e48),this.#proc[_0x1233f4(0xf6)][_0x1233f4(0xc7)](_0x3d5e48),this[_0x1233f4(0xdd)]=!![];var _0x48d570=this;this.#proc['on'](_0x5a3975[_0x1233f4(0xe3)],function(_0x594ed9){_0x48d570['isProcessRunning']=![];});do{const _0x287625=await this['healthcheck']();if(_0x287625)return logger[_0x1233f4(0xe7)](_0x5a3975[_0x1233f4(0xea)]),!![];await this.#sleep(0x3e8);}while(this['isProcessRunning']);return![];}async['stop'](){const _0x3b0cc2=a71_0x243dda,_0x2de73e={'zZxSt':function(_0x398623,_0xfe4501){return _0x398623(_0xfe4501);},'Zrehk':function(_0x4a1e28,_0x37c1a9,_0x44bc77){return _0x4a1e28(_0x37c1a9,_0x44bc77);},'mSUXB':_0x3b0cc2(0xf5),'cJZnq':_0x3b0cc2(0x10a)},_0x54a0a3=await this.#getBinaryPath();return new Promise((_0x1134ca,_0x3721d2)=>{const _0x2a97cb=_0x3b0cc2,_0x50bf2a=_0x2de73e[_0x2a97cb(0xec)](spawn,_0x54a0a3,[_0x2de73e[_0x2a97cb(0xe2)]]);_0x50bf2a['on'](_0x2de73e['cJZnq'],_0xe80e09=>{const _0x37a3e2=_0x2a97cb;this['isProcessRunning']=![],_0x2de73e[_0x37a3e2(0xcd)](_0x1134ca,_0xe80e09);});});}[a71_0x243dda(0xe1)](){const _0x2e2ca1=a71_0x243dda;return this[_0x2e2ca1(0xdd)];}async[a71_0x243dda(0x101)](){const _0x354446=a71_0x243dda,_0x9d1898={};_0x9d1898['qRGGi']='app',_0x9d1898[_0x354446(0xd4)]='automate',_0x9d1898[_0x354446(0x10c)]='GET',_0x9d1898[_0x354446(0xf9)]='Percy\x20fetch\x20token\x20success';const _0x4bdb74=_0x9d1898,_0x2d3ade=this.#config[_0x354446(0xcf)];try{const _0x71165d=this.#isApp?_0x4bdb74['qRGGi']:_0x4bdb74[_0x354446(0xd4)],_0x4c8c8f=await helper[_0x354446(0x100)](_0x4bdb74[_0x354446(0x10c)],_0x354446(0xc8)+_0x2d3ade+_0x354446(0xfe)+_0x71165d,{},this.#config),_0x2bf737=_0x4c8c8f[_0x354446(0xf8)];return logger[_0x354446(0xe7)](_0x4bdb74['WebUu']),_0x2bf737[_0x354446(0x107)];}catch(_0x3f7ea4){return logger[_0x354446(0xdf)](_0x354446(0xfc)+_0x3f7ea4),null;}}async['createPercyConfig'](){const _0x4b3659=a71_0x243dda,_0x46f769={'suHaN':function(_0x1eea48,_0x4761ad){return _0x1eea48(_0x4761ad);},'UWbIq':function(_0x635a74,_0x2cafac){return _0x635a74+_0x2cafac;},'CojLV':_0x4b3659(0xd5),'AfKSD':function(_0x310ade,_0xc5b89a){return _0x310ade(_0xc5b89a);},'tPJJv':_0x4b3659(0xda)};if(!this.#config[_0x4b3659(0xc9)])return null;const _0x2418f0=path[_0x4b3659(0xfd)](os[_0x4b3659(0xfa)](),_0x46f769[_0x4b3659(0xca)]),_0x32b3a4=this.#config[_0x4b3659(0xc9)];return!_0x32b3a4['version']&&(_0x32b3a4['version']='2'),new Promise((_0x4d1aa4,_0x5e800c)=>{const _0x108ca0=_0x4b3659;fs[_0x108ca0(0x106)](_0x2418f0,JSON[_0x108ca0(0xfb)](_0x32b3a4),_0x14769a=>{const _0x2a1f46=_0x108ca0;_0x14769a&&(logger['error']('Error\x20creating\x20percy\x20config:\x20'+_0x14769a),_0x46f769[_0x2a1f46(0xe4)](_0x4d1aa4,null)),logger[_0x2a1f46(0xe7)](_0x46f769[_0x2a1f46(0xf4)](_0x46f769[_0x2a1f46(0x10d)],_0x2418f0)),_0x46f769[_0x2a1f46(0xce)](_0x4d1aa4,_0x2418f0);});});}}module[a71_0x243dda(0x10e)]=Percy;